# キャッシュフロー計算の説明（修正版）

## 🎯 重要な変更点

**従来の問題**: 税抜売上ベースで計算していたため、消費税の預かり金を考慮せず、実際のキャッシュ残高が正しく表示されませんでした。

**修正後**: 税込売上（実際の入金額）ベースで計算し、正確なキャッシュフロー分析が可能になりました。

---

## 📊 計算ロジック

### 1. 損益計算（税抜ベース）- P/L

```
営業利益 = 売上（税抜） - 人件費 - 販管費（税抜）
法人税等 = max(0, 営業利益) × 30%
税引後利益 = 営業利益 - 法人税等
```

### 2. 消費税計算

```
預かり消費税 = 売上（税抜） × 10%
支払消費税 = (販管費インボイスあり × 10%) + (外注費インボイスあり × 10%)
           + (販管費インボイスなし × 10% × 経過措置率) + (外注費インボイスなし × 10% × 経過措置率)
消費税納付額 = 預かり消費税 - 支払消費税
```

**重要**: 人件費（役員報酬・給与）は消費税の対象外

#### 免税事業者等からの仕入れにおける経過措置（図表1）

インボイス制度開始後、免税事業者等からの仕入れについて段階的に控除率が縮小されます：

| 期間 | 控除率 |
|------|--------|
| 2023/10/1～2026/9/30 | **80%** 控除可能 |
| 2026/10/1～2029/9/30 | **50%** 控除可能 |
| 2029/10/1～ | 控除不可 |

### 3. キャッシュフロー計算（税込ベース）

```
【キャッシュイン】
税込売上 = 売上（税抜） × 1.1

【キャッシュアウト】
1. 人件費（非課税）
2. 販管費（税込） = 販管費（税抜） × 1.1
3. 外注費（税込） = 外注費（税抜） × 1.1
4. 法人税
5. 消費税納付額
6. 社会保険料（別表示の場合のみ）

実質キャッシュ残高 = 税込売上 - 人件費 - 販管費（税込） - 外注費（税込） - 法人税 - 消費税納付 - 社保
```

---

## 📈 計算例

### 前提条件
- **売上（税抜）**: 1,000,000,000円
- **役員報酬**: 100,000,000円
- **給与**: 150,000,000円
- **外注費（インボイスあり）**: 50,000,000円
- **販管費（インボイスあり）**: 200,000,000円
- **社保料率**: 15%

---

### ステップ1: 損益計算（税抜ベース）

```
営業利益 = 1,000,000,000 - (100,000,000 + 150,000,000 + 50,000,000) - 200,000,000
         = 1,000,000,000 - 500,000,000
         = 500,000,000円
```

```
法人税等 = 500,000,000 × 30% = 150,000,000円
```

```
税引後利益 = 500,000,000 - 150,000,000 = 350,000,000円
```

---

### ステップ2: 消費税計算

```
預かり消費税 = 1,000,000,000 × 10% = 100,000,000円
```

```
支払消費税 = (200,000,000 + 50,000,000) × 10% = 25,000,000円
```

```
消費税納付額 = 100,000,000 - 25,000,000 = 75,000,000円
```

---

### ステップ3: キャッシュフロー計算

```
【キャッシュイン】
税込売上 = 1,000,000,000 × 1.1 = 1,100,000,000円
```

```
【キャッシュアウト】
1. 人件費: 300,000,000円
2. 販管費（税込）: 200,000,000 × 1.1 = 220,000,000円
3. 外注費（税込）: 50,000,000 × 1.1 = 55,000,000円
4. 法人税: 150,000,000円
5. 消費税納付: 75,000,000円
6. 社保（15%）: 250,000,000 × 15% = 37,500,000円

合計: 837,500,000円
```

```
実質キャッシュ残高 = 1,100,000,000 - 837,500,000 = 262,500,000円 ✅
```

---

## ✅ 検証

従来の間違った計算（税抜ベース）:
```
税引後利益 - 消費税納付 - 社保 = 350,000,000 - 75,000,000 - 37,500,000
                                = 237,500,000円 ❌（誤り）
```

正しい計算（税込ベース）:
```
実質キャッシュ残高 = 262,500,000円 ✅（正解）
```

**差額**: 25,000,000円（販管費・外注費の消費税分）

---

## 💡 重要ポイント

1. ✅ **税込売上を入金として計算** - 実際に入ってくる金額
2. ✅ **支出も税込で計算** - 実際に支払う金額
3. ✅ **消費税は預かり金** - 二重控除しない
4. ✅ **P/L（税抜）とキャッシュフロー（税込）を分離** - 会計と実務の両方が見える
5. ✅ **簡易課税対応可能な構造** - 将来的な拡張が容易

---

## 📌 ユーザーへの表示

- 税込売上（入金）
- 預かり消費税
- 営業利益（税抜）
- 消費税納付額
- 法人税等
- 税引後利益（税抜）
- **💰 実質キャッシュ残高**（強調表示）

これにより、P/Lとキャッシュフローの両方が正確に把握できます。
