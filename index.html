<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµŒå–¶ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
        const STORAGE_KEY = 'tax_simulator_data_v6'; // v6: åŠ´åƒä¿é™ºå¹´åº¦æ›´æ–°è¿½åŠ 

        // åˆæœŸä¼šç¤¾ãƒ‡ãƒ¼ã‚¿ï¼ˆsettingsã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¤¾ä¿æ–™ç‡ã‚’æŒ‡å®šå¯èƒ½ï¼‰
        const createInitialCompany = (id, name, settings = DEFAULT_SETTINGS) => ({
            id,
            name,
            isTaxable: true, // èª²ç¨äº‹æ¥­è€…
            hasInvoice: true, // ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²ã‚ã‚Š
            revenue: 0, // å£²ä¸Šï¼ˆç¨æŠœï¼‰
            
            // å½¹å“¡å ±é…¬
            executiveCompensation: 0,
            executiveCompensationInputMode: 'manual',
            executiveCompensationPercent: 10,
            
            // çµ¦ä¸
            salary: 0,
            salaryInputMode: 'manual',
            salaryPercent: 15,
            
            // å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰
            outsourcingWithInvoice: 0,
            outsourcingWithInvoiceInputMode: 'manual',
            outsourcingWithInvoicePercent: 5,
            
            // å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼‰
            outsourcingWithoutInvoice: 0,
            outsourcingWithoutInvoiceInputMode: 'manual',
            outsourcingWithoutInvoicePercent: 0,
            
            // è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰
            expenseWithInvoice: 0,
            expenseWithInvoiceInputMode: 'manual',
            expenseWithInvoicePercent: 20,
            
            // è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼‰
            expenseWithoutInvoice: 0,
            expenseWithoutInvoiceInputMode: 'manual',
            expenseWithoutInvoicePercent: 5,
            
            // ç¤¾ä¼šä¿é™ºï¼ˆå½¹å“¡å ±é…¬ãƒ»çµ¦ä¸ãã‚Œãã‚Œã«å¯¾ã—ã¦è¨ˆç®—ï¼‰
            includeSocialInsurance: true,
            executiveSocialInsurancePercent: settings.defaultSocialInsuranceRate ?? 15,
            salarySocialInsurancePercent: settings.defaultSocialInsuranceRate ?? 15,

            // â‘  æœŸé¦–ç¾é‡‘ï¼ˆå¹´åˆæ®‹é«˜ï¼‰
            beginningCash: 0,

            // â‘ -2 æœŸé¦–å£²æ›é‡‘ã®å…¥é‡‘ï¼ˆã‚µã‚¤ãƒˆåˆ¥ãƒ»æœˆæ¬¡CFã®å…¥é‡‘ã«åŠ ç®—ï¼‰
            receivablesDay0: 0,   // å½“æœˆå…¥é‡‘åˆ†ï¼ˆ1æœˆå…¥é‡‘ï¼‰
            receivablesDay30: 0,  // ç¿Œæœˆå…¥é‡‘åˆ†ï¼ˆ2æœˆå…¥é‡‘ï¼‰
            receivablesDay60: 0,  // 2ãƒ¶æœˆå¾Œå…¥é‡‘åˆ†ï¼ˆ3æœˆå…¥é‡‘ï¼‰
            receivablesDay90: 0,  // 3ãƒ¶æœˆå¾Œå…¥é‡‘åˆ†ï¼ˆ4æœˆå…¥é‡‘ï¼‰

            // â‘¡ æ”¯æ‰•ã„ã‚µã‚¤ãƒˆï¼ˆæœˆæ¬¡CFç”¨ï¼‰
            salesPaymentDays: 0,      // A) å£²ä¸Š: 0/30/60/90æ—¥
            expensePaymentDays: 0,    // B) è²©ç®¡è²»: 0/30/60/90æ—¥
            salaryPaymentTerms: 'current', // C) çµ¦ä¸: 'current'=å½“æœˆæœ« / 'next'=ç¿Œæœˆæœ«

            // â‘¢ ç¨é‡‘ã®æ”¯æ‰•æœˆï¼ˆ1ã€œ12ï¼‰
            corporateTaxMonth: 3,
            consumptionTaxMonth: 3,

            // ä¸­é–“æ¶ˆè²»ç¨ç”³å‘Šç”¨
            previousPeriodConsumptionTax: 0,
            businessType: 'corporation',
            taxPeriodStartMonth: 4,
            hasExtension: false,

            // æ³•äººç¨ä¸­é–“ç”³å‘Šç”¨
            previousPeriodCorporateTax: 0,
            previousFiscalMonths: 12,
            capitalAmount: 0,
            isLargeCorpSubsidiary: false,
            entityType: 'æ™®é€šæ³•äºº',
            interimIncome: 0,

            // åŠ´åƒä¿é™ºå¹´åº¦æ›´æ–°ç”¨
            laborInsuranceIndustry: 'retail',        // äº‹æ¥­ã®ç¨®é¡
            prevYearConfirmedWages: 0,               // å‰å¹´åº¦ç¢ºå®šè³ƒé‡‘ç·é¡
            prevYearEstimatedWages: 0,               // å‰å¹´åº¦æ¦‚ç®—è³ƒé‡‘ï¼ˆç²¾ç®—ç”¨ãƒ»ä»»æ„ï¼‰
            currYearEstimatedWages: 0,               // å½“å¹´åº¦æ¦‚ç®—è³ƒé‡‘ç·é¡è¦‹è¾¼é¡
            laborInsuranceDelegation: false          // åŠ´åƒä¿é™ºäº‹å‹™çµ„åˆã¸ã®å§”è¨—
        });

        // åŠ´åƒä¿é™ºï¼šæ¥­ç¨®åˆ¥åŠ´ç½ä¿é™ºç‡ï¼ˆâ€°ï¼‰ã€é›‡ç”¨ä¿é™ºç‡ï¼ˆäº‹æ¥­ä¸»ãƒ»åŠ´åƒè€…ï¼…ï¼‰
        const LABOR_INDUSTRY_RATES = {
            retail:     { name: 'å°å£²æ¥­ãƒ»å¸å£²æ¥­ãƒ»é£²é£Ÿåº—ç­‰', rosaRate: 2.5, empEmployer: 0.9, empWorker: 0.55 },
            construction: { name: 'å»ºè¨­æ¥­', rosaRate: 34, empEmployer: 1.1, empWorker: 0.65 },
            manufacturing: { name: 'è£½é€ æ¥­', rosaRate: 6, empEmployer: 0.9, empWorker: 0.55 },
            forestry:   { name: 'æ—æ¥­', rosaRate: 52, empEmployer: 1.0, empWorker: 0.65 },
            finance:    { name: 'é‡‘èãƒ»ä¿é™ºãƒ»ä¸å‹•ç”£', rosaRate: 2.5, empEmployer: 0.9, empWorker: 0.55 },
            transport:  { name: 'äº¤é€šé‹è¼¸äº‹æ¥­', rosaRate: 4, empEmployer: 0.9, empWorker: 0.55 },
            other:      { name: 'ãã®ä»–ä¸€èˆ¬', rosaRate: 3, empEmployer: 0.9, empWorker: 0.55 }
        };
        const ASBESTOS_RATE = 0.00002; // ä¸€èˆ¬æ‹ å‡ºé‡‘ 1000åˆ†ã®0.02

        // é›‡ç”¨ä¿é™ºåŠ´åƒè€…è² æ‹…ã®ç«¯æ•°å‡¦ç†ï¼ˆ50éŠ­ä»¥ä¸‹åˆ‡æ¨ã€50éŠ­1å˜ä»¥ä¸Šåˆ‡ä¸Šï¼‰
        const roundEmploymentWorker = (val) => {
            const dec = val - Math.floor(val);
            return dec <= 0.5 ? Math.floor(val) : Math.ceil(val);
        };

        // ============================================================
        // åŠ´åƒä¿é™ºå¹´åº¦æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
        // ============================================================
        const LABOR_EXTEND_THRESHOLD = 400000;   // å»¶ç´é–¾å€¤ï¼ˆä¸¡ä¿é™ºï¼‰
        const LABOR_EXTEND_THRESHOLD_SINGLE = 200000;

        const calculateLaborInsurance = (company, year) => {
            const ind = LABOR_INDUSTRY_RATES[company.laborInsuranceIndustry] || LABOR_INDUSTRY_RATES.other;
            const prevWages = company.prevYearConfirmedWages || 0;
            const prevEstWages = company.prevYearEstimatedWages || prevWages; // æœªå…¥åŠ›æ™‚ã¯ç¢ºå®šé¡ã§æ¨å®š
            const currWages = company.currYearEstimatedWages || 0;
            const delegated = !!company.laborInsuranceDelegation;

            const rosaRate = ind.rosaRate / 1000;  // åŠ´ç½ä¿é™ºç‡
            const empEmployer = ind.empEmployer / 100;
            const empWorker = ind.empWorker / 100;

            // å½“å¹´åº¦æ¦‚ç®—ä¿é™ºæ–™
            const rosaEstimated = Math.round(currWages * rosaRate);
            const empEmployerEstimated = Math.round(currWages * empEmployer);
            const empWorkerEstimated = roundEmploymentWorker(currWages * empWorker);
            const asbestosEstimated = Math.round(currWages * ASBESTOS_RATE);
            const employerPortion = rosaEstimated + empEmployerEstimated + asbestosEstimated;
            const workerPortion = empWorkerEstimated;
            const totalEstimated = employerPortion + workerPortion;

            // å‰å¹´åº¦ç¢ºå®šä¿é™ºæ–™ãƒ»å‰å¹´åº¦æ¦‚ç®—ç´ä»˜é¡
            const prevRosa = Math.round(prevWages * rosaRate);
            const prevEmpEmployer = Math.round(prevWages * empEmployer);
            const prevEmpWorker = roundEmploymentWorker(prevWages * empWorker);
            const prevAsbestos = Math.round(prevWages * ASBESTOS_RATE);
            const prevConfirmedTotal = prevRosa + prevEmpEmployer + prevEmpWorker + prevAsbestos;
            const prevEstRosa = Math.round(prevEstWages * rosaRate);
            const prevEstEmpEmployer = Math.round(prevEstWages * empEmployer);
            const prevEstEmpWorker = roundEmploymentWorker(prevEstWages * empWorker);
            const prevEstAsbestos = Math.round(prevEstWages * ASBESTOS_RATE);
            const prevEstimatedTotal = prevEstRosa + prevEstEmpEmployer + prevEstEmpWorker + prevEstAsbestos;
            const prevSettlement = prevConfirmedTotal - prevEstimatedTotal; // å‰å¹´åº¦ç²¾ç®—å·®é¡

            // å¹´åº¦æ›´æ–°ï¼šå½“å¹´åº¦æ¦‚ç®— + å‰å¹´åº¦ç²¾ç®—å·®é¡ï¼ˆãƒã‚¤ãƒŠã‚¹ã¯é‚„ä»˜ï¼‰
            const annualUpdateTotal = totalEstimated + prevSettlement;

            // å»¶ç´åˆ¤å®šï¼šæ¦‚ç®—40ä¸‡ä»¥ä¸Šã€ã¾ãŸã¯äº‹å‹™çµ„åˆå§”è¨—ã€‚åˆ†å‰²ã¯å¹´åº¦æ›´æ–°ç´ä»˜é¡ã‚’3ç­‰åˆ†
            const canExtend = totalEstimated >= LABOR_EXTEND_THRESHOLD || delegated;
            const payAmount = Math.max(0, annualUpdateTotal);
            const installments = canExtend && payAmount > 0 ? [
                { period: 1, amount: Math.ceil(payAmount / 3), dueDate: `${year}å¹´7æœˆ10æ—¥` },
                { period: 2, amount: Math.ceil(payAmount / 3), dueDate: `${year}å¹´10æœˆ31æ—¥` },
                { period: 3, amount: payAmount - Math.ceil(payAmount / 3) * 2, dueDate: `${year + 1}å¹´1æœˆ31æ—¥` }
            ] : [];

            return {
                industryName: ind.name,
                employerPortion,
                workerPortion,
                totalEstimated,
                prevConfirmedTotal,
                prevSettlement,
                annualUpdateTotal,
                dueDate: `${year}å¹´6æœˆ1æ—¥ï½7æœˆ10æ—¥`,
                canExtend,
                installments
            };
        };

        // å…ç¨äº‹æ¥­è€…ç­‰ã‹ã‚‰ã®ä»•å…¥ã‚Œã«ãŠã‘ã‚‹çµŒéæªç½®ã®æ§é™¤ç‡ã‚’å–å¾—
        // å›³è¡¨1ã€Œå…ç¨äº‹æ¥­è€…ç­‰ã‹ã‚‰ã®ä»•å…¥ã‚Œã«ãŠã‘ã‚‹çµŒéæªç½®ã€ã«åŸºã¥ãï¼ˆå¹´æœˆã§åˆ¤å®šï¼‰
        // 2023/10/1ï½2026/9/30: 80% | 2026/10/1ï½2029/9/30: 50% | 2029/10/1ï½: æ§é™¤ä¸å¯
        const getTaxExemptDeductionRate = (year, month) => {
            const dateValue = year * 100 + (month || 1);
            if (dateValue < 202610) return 0.8;
            if (dateValue < 202910) return 0.5;
            return 0;
        };

        // ============================================================
        // ä¸­é–“æ¶ˆè²»ç¨ç”³å‘Šãƒ­ã‚¸ãƒƒã‚¯
        // ============================================================
        const THRESHOLD_48 = 480000;
        const THRESHOLD_400 = 4000000;
        const THRESHOLD_4800 = 48000000;
        const LOCAL_TAX_RATIO = 22 / 78;

        const calculateInterimConsumptionTax = (company, year) => {
            const tax = company.previousPeriodConsumptionTax || 0;
            const startMonth = company.taxPeriodStartMonth || 4;
            const isCorp = company.businessType === 'corporation';
            const hasExt = !!company.hasExtension;
            let interimCount = 0;
            let isRequired = false;
            if (tax <= THRESHOLD_48) { interimCount = 0; isRequired = false; }
            else if (tax <= THRESHOLD_400) { interimCount = 1; isRequired = true; }
            else if (tax <= THRESHOLD_4800) { interimCount = 3; isRequired = true; }
            else { interimCount = 11; isRequired = true; }
            const periods = [];
            if (interimCount === 0) return { isRequired, interimCount, periods, note: '48ä¸‡å††ä»¥ä¸‹ã¯åŸå‰‡ä¸è¦ï¼ˆä»»æ„ç”³å‘Šåˆ¶åº¦ã‚ã‚Šï¼‰' };
            const monthsPerPeriod = interimCount === 1 ? 6 : interimCount === 3 ? 4 : 1;
            const taxRatio = monthsPerPeriod / 12;
            for (let i = 0; i < interimCount; i++) {
                const consumptionTaxAmount = Math.round(tax * taxRatio);
                const localTaxAmount = Math.round(consumptionTaxAmount * LOCAL_TAX_RATIO);
                const totalAmount = consumptionTaxAmount + localTaxAmount;
                let dueYear = year, dueMonth;
                const periodEndMonth1 = startMonth + (i + 1) * monthsPerPeriod - 1;
                const periodEndYear = year + Math.floor((periodEndMonth1 - 1) / 12);
                const periodEndMonth = ((periodEndMonth1 - 1) % 12) + 1;
                if (isCorp && hasExt && i === 0) {
                    const t = startMonth + 5;
                    dueMonth = ((t - 1) % 12) + 1;
                    dueYear = year + Math.floor((t - 1) / 12);
                } else {
                    dueMonth = periodEndMonth + 2 > 12 ? periodEndMonth - 10 : periodEndMonth + 2;
                    dueYear = periodEndMonth + 2 > 12 ? periodEndYear + 1 : periodEndYear;
                }
                periods.push({ periodNum: i + 1, consumptionTax: consumptionTaxAmount, localConsumptionTax: localTaxAmount, total: totalAmount, dueDate: `${dueYear}å¹´${dueMonth}æœˆ` });
            }
            return { isRequired, interimCount, periods, note: null };
        };

        // ============================================================
        // æ³•äººç¨ä¸­é–“ç”³å‘Šãƒ­ã‚¸ãƒƒã‚¯
        // ============================================================
        const INTERIM_THRESHOLD = 100000;
        const CAPITAL_1B = 100000000;
        const INCOME_10B = 1000000000;
        const LOCAL_CORP_TAX_RATE = 0.103;

        const calculateInterimCorporateTax = (company) => {
            const prevTax = company.previousPeriodCorporateTax || 0;
            const prevMonths = company.previousFiscalMonths || 12;
            const capital = company.capitalAmount || 0;
            const isLargeSub = !!company.isLargeCorpSubsidiary;
            const entityType = company.entityType || 'æ™®é€šæ³•äºº';
            const income6m = company.interimIncome || 0;
            const scheduledBaseTax = prevTax * 6 / prevMonths;
            const isRequired = scheduledBaseTax > INTERIM_THRESHOLD;
            const scheduledNationalTax = Math.round(scheduledBaseTax);
            const scheduledLocalTax = Math.round(scheduledNationalTax * LOCAL_CORP_TAX_RATE);
            const scheduledTotal = scheduledNationalTax + scheduledLocalTax;
            let rateBasis = 'æ™®é€šæ³•äºº';
            const isSmallCorp = capital <= CAPITAL_1B && !isLargeSub;
            if (entityType === 'åŒ»ç™‚æ³•äºº') rateBasis = 'ç‰¹å®šã®åŒ»ç™‚æ³•äºº';
            else if (capital > CAPITAL_1B || isLargeSub) rateBasis = 'è³‡æœ¬é‡‘1å„„å††è¶…ã®æ™®é€šæ³•äººåˆã¯å¤§æ³•äºº100%å­ä¼šç¤¾';
            else rateBasis = 'ä¸­å°æ³•äººï¼ˆè³‡æœ¬é‡‘1å„„å††ä»¥ä¸‹ï¼‰';
            let provisionalNationalTax = 0;
            let provisionalNote = null;
            if (income6m > 0) {
                const incomeAnnual = income6m * 2;
                const threshold6m = 4000000;
                if (entityType === 'åŒ»ç™‚æ³•äºº') {
                    provisionalNationalTax = Math.round(Math.min(income6m, threshold6m) * 0.15 + Math.max(0, income6m - threshold6m) * 0.19);
                } else if (!isSmallCorp) {
                    provisionalNationalTax = Math.round(income6m * 0.232);
                } else {
                    const rate1 = incomeAnnual > INCOME_10B ? 0.17 : 0.15;
                    provisionalNationalTax = Math.round(Math.min(income6m, threshold6m) * rate1 + Math.max(0, income6m - threshold6m) * 0.232);
                }
            } else if (income6m < 0) {
                provisionalNationalTax = 0;
                provisionalNote = 'ä»®æ±ºç®—ã§èµ¤å­—ã®å ´åˆã€ä¸­é–“ç”³å‘Šã§é‚„ä»˜ã¯å—ã‘ã‚‰ã‚Œãªã„ï¼ˆ0å††ï¼‰';
            }
            const provisionalLocalTax = Math.round(provisionalNationalTax * LOCAL_CORP_TAX_RATE);
            const provisionalTotal = provisionalNationalTax + provisionalLocalTax;
            return { isRequired, scheduledNationalTax, scheduledLocalTax, scheduledTotal, provisionalNationalTax, provisionalLocalTax, provisionalTotal, rateBasis, provisionalNote, hasProvisionalInput: income6m !== 0 };
        };

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆç”»é¢ã§å¤‰æ›´å¯èƒ½ï¼‰
        const DEFAULT_SETTINGS = {
            consumptionTaxRate: 10,       // æ¶ˆè²»ç¨ç‡ï¼ˆ%ï¼‰
            defaultSocialInsuranceRate: 15, // æ–°è¦ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¤¾ä¿æ–™ç‡ï¼ˆ%ï¼‰
            showIntermediateTaxSection: true, // ä¸­é–“ç”³å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
            showMonthlyCFSection: true   // æœˆæ¬¡CFã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        };

        // è¨ˆç®—é–¢æ•°ï¼ˆsettingsã‚’æ¸¡ã™å ´åˆã¯ä½¿ç”¨ã€æœªæŒ‡å®šæ™‚ã¯DEFAULT_SETTINGSï¼‰
        const calculateKPI = (company, year, month, settings = DEFAULT_SETTINGS) => {
            const { revenue, isTaxable, includeSocialInsurance,
                    // å½¹å“¡å ±é…¬
                    executiveCompensation, executiveCompensationInputMode, executiveCompensationPercent,
                    // çµ¦ä¸
                    salary, salaryInputMode, salaryPercent,
                    // å¤–æ³¨è²»
                    outsourcingWithInvoice, outsourcingWithInvoiceInputMode, outsourcingWithInvoicePercent,
                    outsourcingWithoutInvoice, outsourcingWithoutInvoiceInputMode, outsourcingWithoutInvoicePercent,
                    // è²©ç®¡è²»
                    expenseWithInvoice, expenseWithInvoiceInputMode, expenseWithInvoicePercent,
                    expenseWithoutInvoice, expenseWithoutInvoiceInputMode, expenseWithoutInvoicePercent,
                    // ç¤¾ä¿æ–™ç‡
                    executiveSocialInsurancePercent, salarySocialInsurancePercent } = company;

            // å®Ÿéš›ã®é‡‘é¡ã‚’è¨ˆç®—ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆå…¥åŠ›ã®å ´åˆã¯å£²ä¸Šã‹ã‚‰è¨ˆç®—ï¼‰
            const actualExecutiveCompensation = executiveCompensationInputMode === 'percent' 
                ? revenue * (executiveCompensationPercent / 100)
                : executiveCompensation;
            
            const actualSalary = salaryInputMode === 'percent'
                ? revenue * (salaryPercent / 100)
                : salary;
            
            const actualOutsourcingWithInvoice = outsourcingWithInvoiceInputMode === 'percent'
                ? revenue * (outsourcingWithInvoicePercent / 100)
                : outsourcingWithInvoice;
            
            const actualOutsourcingWithoutInvoice = outsourcingWithoutInvoiceInputMode === 'percent'
                ? revenue * (outsourcingWithoutInvoicePercent / 100)
                : outsourcingWithoutInvoice;
            
            const actualExpenseWithInvoice = expenseWithInvoiceInputMode === 'percent'
                ? revenue * (expenseWithInvoicePercent / 100)
                : expenseWithInvoice;
            
            const actualExpenseWithoutInvoice = expenseWithoutInvoiceInputMode === 'percent'
                ? revenue * (expenseWithoutInvoicePercent / 100)
                : expenseWithoutInvoice;

            // ç¤¾ä¼šä¿é™ºæ–™ã®è¨ˆç®—ï¼ˆå½¹å“¡å ±é…¬ã¨çµ¦ä¸ãã‚Œãã‚Œã«å¯¾ã—ã¦ï¼‰
            const executiveSocialInsuranceCost = actualExecutiveCompensation * (executiveSocialInsurancePercent / 100);
            const salarySocialInsuranceCost = actualSalary * (salarySocialInsurancePercent / 100);
            const totalSocialInsuranceCost = executiveSocialInsuranceCost + salarySocialInsuranceCost;

            // äººä»¶è²»åˆè¨ˆï¼ˆå½¹å“¡å ±é…¬ + çµ¦ä¸ + å¤–æ³¨è²»ï¼‰
            const totalLaborCost = actualExecutiveCompensation + actualSalary + actualOutsourcingWithInvoice + actualOutsourcingWithoutInvoice;

            // ============================================================
            // æç›Šè¨ˆç®—ï¼ˆç¨æŠœãƒ™ãƒ¼ã‚¹ï¼‰
            // ============================================================
            
            // â‘  å–¶æ¥­åˆ©ç›Šï¼ˆç¨æŠœãƒ™ãƒ¼ã‚¹ï¼‰
            const operatingProfit = revenue - totalLaborCost - (actualExpenseWithInvoice + actualExpenseWithoutInvoice);

            // â‘¡ æ³•äººç¨ç­‰ã®è¨ˆç®—ï¼ˆä¸­å°ä¼æ¥­è€…å‘ã‘ï¼‰
            // å¹´é–“èª²ç¨æ‰€å¾— = å–¶æ¥­åˆ©ç›Š
            const taxableIncome = Math.max(0, operatingProfit);
            
            let nationalCorporateTax = 0; // æ³•äººç¨
            let localCorporateTax = 0; // åœ°æ–¹æ³•äººç¨
            let businessTax = 0; // æ³•äººäº‹æ¥­ç¨
            let specialBusinessTax = 0; // ç‰¹åˆ¥æ³•äººäº‹æ¥­ç¨
            let residentTax = 0; // æ³•äººä½æ°‘ç¨
            
            if (taxableIncome > 0) {
                // ä¸­å°ä¼æ¥­è€…ã®æ³•äººç¨ç‡ï¼ˆè³‡æœ¬é‡‘1å„„å††ä»¥ä¸‹ï¼‰
                // èª²ç¨æ‰€å¾—800ä¸‡å††ä»¥ä¸‹: 15.0%
                // èª²ç¨æ‰€å¾—800ä¸‡å††è¶…: 23.2%
                
                const threshold = 8000000; // 800ä¸‡å††
                
                if (taxableIncome <= threshold) {
                    // 800ä¸‡å††ä»¥ä¸‹ã®éƒ¨åˆ†
                    nationalCorporateTax = taxableIncome * 0.15;
                } else {
                    // 800ä¸‡å††ä»¥ä¸‹ã®éƒ¨åˆ† + 800ä¸‡å††è¶…ã®éƒ¨åˆ†
                    nationalCorporateTax = (threshold * 0.15) + ((taxableIncome - threshold) * 0.232);
                }
                
                // åœ°æ–¹æ³•äººç¨ï¼ˆæ³•äººç¨é¡ã®10.3%ï¼‰
                localCorporateTax = nationalCorporateTax * 0.103;
                
                // æ³•äººäº‹æ¥­ç¨ï¼ˆä¸­å°ä¼æ¥­è€…ï¼‰
                const bt_threshold1 = 4000000; // 400ä¸‡å††
                const bt_threshold2 = 8000000; // 800ä¸‡å††
                
                if (taxableIncome <= bt_threshold1) {
                    businessTax = taxableIncome * 0.035;
                } else if (taxableIncome <= bt_threshold2) {
                    businessTax = (bt_threshold1 * 0.035) + ((taxableIncome - bt_threshold1) * 0.053);
                } else {
                    businessTax = (bt_threshold1 * 0.035) + ((bt_threshold2 - bt_threshold1) * 0.053) + ((taxableIncome - bt_threshold2) * 0.07);
                }
                
                // ç‰¹åˆ¥æ³•äººäº‹æ¥­ç¨ï¼ˆæ³•äººäº‹æ¥­ç¨é¡ã®37.0%ï¼‰
                specialBusinessTax = businessTax * 0.37;
                
                // æ³•äººä½æ°‘ç¨ï¼ˆæ‰€å¾—å‰²ï¼šæ³•äººç¨é¡ã®7.0% + å‡ç­‰å‰²ï¼š70,000å††ï¼‰
                residentTax = (nationalCorporateTax * 0.07) + 70000;
            }
            
            // æ³•äººç¨ç­‰åˆè¨ˆ
            const corporateTax = nationalCorporateTax + localCorporateTax + businessTax + specialBusinessTax + residentTax;

            // â‘¢ ç¨å¼•å¾Œåˆ©ç›Šï¼ˆç¨æŠœãƒ™ãƒ¼ã‚¹ï¼‰
            const netProfit = operatingProfit - corporateTax;

            // ============================================================
            // æ¶ˆè²»ç¨è¨ˆç®—
            // ============================================================
            
            const taxRate = (settings.consumptionTaxRate || 10) / 100;
            // é ã‹ã‚Šæ¶ˆè²»ç¨ï¼ˆå£²ä¸ŠÃ—æ¶ˆè²»ç¨ç‡ï¼‰
            const receivedConsumptionTax = revenue * taxRate;
            // æ”¯æ‰•æ¶ˆè²»ç¨ï¼ˆä»•å…¥æ§é™¤ï¼šè²©ç®¡è²»ï¼‹å¤–æ³¨è²»ï¼‰
            const taxExemptDeductionRate = getTaxExemptDeductionRate(year, month);
            const paidConsumptionTax = (actualExpenseWithInvoice * taxRate) + (actualOutsourcingWithInvoice * taxRate)
                + (actualExpenseWithoutInvoice * taxRate * taxExemptDeductionRate)
                + (actualOutsourcingWithoutInvoice * taxRate * taxExemptDeductionRate);
            
            // æ¶ˆè²»ç¨ç´ä»˜é¡ = é ã‹ã‚Šæ¶ˆè²»ç¨ - æ”¯æ‰•æ¶ˆè²»ç¨
            const consumptionTax = isTaxable 
                ? receivedConsumptionTax - paidConsumptionTax
                : 0;

            // ============================================================
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—ï¼ˆç¨è¾¼ãƒ™ãƒ¼ã‚¹ï¼‰
            // ============================================================
            
            const taxMultiplier = 1 + taxRate;
            // ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ã€‘
            const taxIncludedRevenue = revenue * taxMultiplier;
            
            // ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ã‚¦ãƒˆã€‘
            // 1. äººä»¶è²»ï¼ˆéèª²ç¨ãªã®ã§ãã®ã¾ã¾ï¼‰
            const cashOutLabor = totalLaborCost;
            
            // 2. è²©ç®¡è²»ï¼ˆç¨è¾¼ï¼‰
            const cashOutExpense = (actualExpenseWithInvoice + actualExpenseWithoutInvoice) * taxMultiplier;
            // 3. å¤–æ³¨è²»ï¼ˆç¨è¾¼ï¼‰
            const cashOutOutsourcing = (actualOutsourcingWithInvoice + actualOutsourcingWithoutInvoice) * taxMultiplier;
            
            // 4. æ³•äººç¨
            const cashOutCorporateTax = corporateTax;
            
            // 5. æ¶ˆè²»ç¨ç´ä»˜é¡
            const cashOutConsumptionTax = consumptionTax;
            
            // 6. ç¤¾ä¼šä¿é™ºæ–™ï¼ˆåˆ¥è¡¨ç¤ºã®å ´åˆã®ã¿ï¼‰
            const socialInsuranceDeduction = includeSocialInsurance ? 0 : totalSocialInsuranceCost;
            const cashOutSocialInsurance = socialInsuranceDeduction;
            
            // å®Ÿè³ªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®‹é«˜
            // = ç¨è¾¼å£²ä¸Š - äººä»¶è²» - è²©ç®¡è²»ï¼ˆç¨è¾¼ï¼‰ - å¤–æ³¨è²»ï¼ˆç¨è¾¼ï¼‰ - æ³•äººç¨ - æ¶ˆè²»ç¨ç´ä»˜ - ç¤¾ä¿
            const actualCash = taxIncludedRevenue 
                - cashOutLabor 
                - cashOutExpense 
                - cashOutOutsourcing 
                - cashOutCorporateTax 
                - cashOutConsumptionTax 
                - cashOutSocialInsurance;

            return {
                // æç›Šè¨ˆç®—ï¼ˆç¨æŠœãƒ™ãƒ¼ã‚¹ï¼‰
                operatingProfit,
                taxableIncome, // èª²ç¨æ‰€å¾—
                corporateTax, // æ³•äººç¨ç­‰åˆè¨ˆ
                nationalCorporateTax, // æ³•äººç¨
                localCorporateTax, // åœ°æ–¹æ³•äººç¨
                businessTax, // æ³•äººäº‹æ¥­ç¨
                specialBusinessTax, // ç‰¹åˆ¥æ³•äººäº‹æ¥­ç¨
                residentTax, // æ³•äººä½æ°‘ç¨
                netProfit,
                
                // æ¶ˆè²»ç¨é–¢é€£
                consumptionTax,
                receivedConsumptionTax, // é ã‹ã‚Šæ¶ˆè²»ç¨
                paidConsumptionTax, // æ”¯æ‰•æ¶ˆè²»ç¨
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼
                taxIncludedRevenue, // ç¨è¾¼å£²ä¸Š
                actualCash, // å®Ÿè³ªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®‹é«˜
                
                // è©³ç´°æƒ…å ±
                actualExecutiveCompensation,
                actualSalary,
                actualOutsourcingWithInvoice,
                actualOutsourcingWithoutInvoice,
                totalLaborCost,
                executiveSocialInsuranceCost,
                salarySocialInsuranceCost,
                totalSocialInsuranceCost,
                actualExpenseWithInvoice,
                actualExpenseWithoutInvoice
            };
        };

        // ============================================================
        // â‘£ æœˆæ¬¡ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—ï¼ˆã‚µã‚¤ãƒˆè€ƒæ…®ï¼‰
        // ============================================================
        // ã‚µã‚¤ãƒˆ: 0æ—¥=å½“æœˆ, 30æ—¥=ç¿Œæœˆ, 60æ—¥=2ãƒ¶æœˆå¾Œ, 90æ—¥=3ãƒ¶æœˆå¾Œ
        const getMonthOffset = (days) => Math.floor((days || 0) / 30);

        // æš¦æœˆ(dueYear,dueMonth)ã‚’å¹´åº¦yearãƒ»æœŸé¦–startMonthã®æœˆç•ªå·(1-12)ã«å¤‰æ›ã€‚å¹´åº¦å†…ã§ãªã‘ã‚Œã°0
        const calendarToFiscalMonth = (dueYear, dueMonth, year, startMonth) => {
            const fyStart = startMonth || 4;
            if (dueYear < year) return 0;
            if (dueYear > year + 1) return 0;
            if (dueYear === year && dueMonth >= fyStart) return dueMonth - fyStart + 1;
            if (dueYear === year + 1 && dueMonth < fyStart) return dueMonth + (12 - fyStart + 1);
            return 0;
        };

        // ä¸­é–“æ¶ˆè²»ç¨ãƒ»æ³•äººç¨ä¸­é–“ç”³å‘Šã‚’æœˆåˆ¥å‡ºé‡‘ã¨ã—ã¦å–å¾— { items: {month, amount, type}[], totalCorp, totalCons }
        const getInterimTaxOutflowsByMonth = (company, year) => {
            const startMonth = company.taxPeriodStartMonth || 4;
            const items = [];
            let totalCons = 0;
            const ct = calculateInterimConsumptionTax(company, year);
            if (ct.periods && ct.periods.length) {
                ct.periods.forEach(p => {
                    const amt = (p.consumptionTax || 0) + (p.localConsumptionTax || 0);
                    totalCons += amt;
                    const match = (p.dueDate || '').match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                    if (match) {
                        const dueYear = parseInt(match[1], 10);
                        const dueMonth = parseInt(match[2], 10);
                        const fm = calendarToFiscalMonth(dueYear, dueMonth, year, startMonth);
                        if (fm >= 1 && fm <= 12) items.push({ month: fm, amount: amt, type: 'cons' });
                    }
                });
            }
            let totalCorp = 0;
            const corp = calculateInterimCorporateTax(company);
            if (corp.isRequired) {
                const amt = corp.hasProvisionalInput ? (corp.provisionalNationalTax || 0) + (corp.provisionalLocalTax || 0) : (corp.scheduledNationalTax || 0) + (corp.scheduledLocalTax || 0);
                if (amt > 0) {
                    totalCorp = amt;
                    const periodEndMonth = startMonth + 5;
                    const dueMonth = periodEndMonth + 2 > 12 ? periodEndMonth - 10 : periodEndMonth + 2;
                    const dueYear = periodEndMonth + 2 > 12 ? year + 1 : year;
                    const fm = calendarToFiscalMonth(dueYear, dueMonth, year, startMonth);
                    if (fm >= 1 && fm <= 12) items.push({ month: fm, amount: amt, type: 'corp' });
                }
            }
            return { items, totalCorp, totalCons };
        };

        const calculateMonthlyCashFlow = (company, year, settings = DEFAULT_SETTINGS) => {
            const kpi = calculateKPI(company, year, 1, settings);
            const {
                taxIncludedRevenue,
                corporateTax,
                consumptionTax,
                actualExecutiveCompensation,
                actualSalary,
                totalSocialInsuranceCost,
                actualExpenseWithInvoice,
                actualExpenseWithoutInvoice,
                actualOutsourcingWithInvoice,
                actualOutsourcingWithoutInvoice
            } = kpi;

            const beginningCash = company.beginningCash || 0;
            const salesOffset = getMonthOffset(company.salesPaymentDays || 0);
            const expenseOffset = getMonthOffset(company.expensePaymentDays || 0);
            const salaryOffset = company.salaryPaymentTerms === 'next' ? 1 : 0;
            const corporateTaxMonth = company.corporateTaxMonth || 3;
            const consumptionTaxMonth = company.consumptionTaxMonth || 3;

            const taxMultiplier = 1 + (settings.consumptionTaxRate || 10) / 100;
            const monthlySales = taxIncludedRevenue / 12;
            const monthlyExpense = (actualExpenseWithInvoice + actualExpenseWithoutInvoice
                + actualOutsourcingWithInvoice + actualOutsourcingWithoutInvoice) * taxMultiplier / 12;
            const monthlyLabor = (actualExecutiveCompensation + actualSalary
                + (company.includeSocialInsurance ? totalSocialInsuranceCost : 0)) / 12;

            const receivablesDay0 = company.receivablesDay0 || 0;
            const receivablesDay30 = company.receivablesDay30 || 0;
            const receivablesDay60 = company.receivablesDay60 || 0;
            const receivablesDay90 = company.receivablesDay90 || 0;

            const { items: interimTaxItems, totalCorp: totalInterimCorp, totalCons: totalInterimCons } = getInterimTaxOutflowsByMonth(company, year);
            const finalCorporateTaxAmount = Math.max(0, corporateTax - totalInterimCorp);
            const finalConsumptionTaxAmount = Math.max(0, consumptionTax - totalInterimCons);

            const result = [];
            let balance = beginningCash;

            for (let m = 1; m <= 12; m++) {
                // å…¥é‡‘: å£²ä¸Šã‚’ã‚µã‚¤ãƒˆåˆ†ãšã‚‰ã—ã¦è¨ˆä¸Š + æœŸé¦–å£²æ›é‡‘ã®å…¥é‡‘ï¼ˆ1æœˆ=0æ—¥åˆ†ã€2æœˆ=30æ—¥åˆ†ã€3æœˆ=60æ—¥åˆ†ã€4æœˆ=90æ—¥åˆ†ï¼‰
                let salesInflow = (m - salesOffset >= 1) ? monthlySales : 0;
                const receivablesInflow = (m === 1 ? receivablesDay0 : m === 2 ? receivablesDay30 : m === 3 ? receivablesDay60 : m === 4 ? receivablesDay90 : 0);
                const inflow = salesInflow + receivablesInflow;

                // å‡ºé‡‘: è²©ç®¡è²»ï¼‹çµ¦ä¸ã‚’ã‚µã‚¤ãƒˆåˆ†ãšã‚‰ã—ï¼‹æ³•äººç¨ãƒ»æ¶ˆè²»ç¨ï¼ˆä¸­é–“ã¯å½“è©²æœˆã€ç¢ºå®šã¯ä¸­é–“æ§é™¤å¾Œã®æœ€çµ‚ç´ä»˜é¡ï¼‰
                const expenseOut = (m - expenseOffset >= 1) ? monthlyExpense : 0;
                const laborOut = (m - salaryOffset >= 1) ? monthlyLabor : 0;
                const finalCorporateTax = m === corporateTaxMonth ? finalCorporateTaxAmount : 0;
                const finalConsumptionTax = m === consumptionTaxMonth ? finalConsumptionTaxAmount : 0;
                const interimOut = interimTaxItems.filter(t => t.month === m).reduce((s, t) => s + t.amount, 0);
                const taxOut = finalCorporateTax + finalConsumptionTax + interimOut;

                const outflow = expenseOut + laborOut + taxOut;
                const netCF = inflow - outflow;
                balance += netCF;

                result.push({ month: m, inflow, outflow, netCF, balance });
            }
            return result;
        };

        // â‘¥ ã‚°ãƒ«ãƒ¼ãƒ—åˆç®—CFï¼ˆå…¨ç¤¾ã®æœˆæ¬¡ã‚’å˜ç´”åˆç®—ï¼‰
        const calculateGroupMonthlyCF = (companies, year, settings = DEFAULT_SETTINGS) => {
            const monthlyData = companies.map(c => calculateMonthlyCashFlow(c, year, settings));
            const result = [];
            const groupBeginningCash = companies.reduce((sum, c) => sum + (c.beginningCash || 0), 0);
            // å£²æ›é‡‘å…¥é‡‘ã¯å„ç¤¾åˆ†ã‚’æœˆæ¬¡ã§åˆç®—æ¸ˆã¿ï¼ˆcalculateMonthlyCashFlowã«å«ã¾ã‚Œã‚‹ï¼‰
            let balance = groupBeginningCash;

            for (let m = 1; m <= 12; m++) {
                let inflow = 0, outflow = 0;
                monthlyData.forEach(data => {
                    const row = data.find(r => r.month === m);
                    if (row) { inflow += row.inflow; outflow += row.outflow; }
                });
                const netCF = inflow - outflow;
                balance += netCF;
                result.push({ month: m, inflow, outflow, netCF, balance });
            }
            return result;
        };

        // ã‚°ãƒ«ãƒ¼ãƒ—åˆç®—è¨ˆç®—ï¼ˆå¾“æ¥KPIç”¨ï¼‰
        const calculateGroupTotal = (companies, year, month, settings = DEFAULT_SETTINGS) => {
            const totals = {
                operatingProfit: 0,
                consumptionTax: 0,
                receivedConsumptionTax: 0,
                paidConsumptionTax: 0,
                corporateTax: 0,
                netProfit: 0,
                taxIncludedRevenue: 0,
                actualCash: 0,
                totalSocialInsuranceCost: 0
            };

            companies.forEach(company => {
                const kpi = calculateKPI(company, year, month, settings);
                totals.operatingProfit += kpi.operatingProfit;
                totals.consumptionTax += kpi.consumptionTax;
                totals.receivedConsumptionTax += kpi.receivedConsumptionTax;
                totals.paidConsumptionTax += kpi.paidConsumptionTax;
                totals.corporateTax += kpi.corporateTax;
                totals.netProfit += kpi.netProfit;
                totals.taxIncludedRevenue += kpi.taxIncludedRevenue;
                totals.actualCash += kpi.actualCash;
                totals.totalSocialInsuranceCost += kpi.totalSocialInsuranceCost;
            });

            return totals;
        };

        // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('ja-JP').format(Math.round(value));
        };

        // å…¥åŠ›å€¤ã‹ã‚‰ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦æ•°å€¤åŒ–
        const parseNumber = (value) => {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            const cleaned = String(value).replace(/,/g, '');
            return Number(cleaned) || 0;
        };

        // æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚«ãƒ³ãƒä»˜ãè¡¨ç¤ºï¼‰
        const formatInputValue = (value) => {
            if (!value && value !== 0) return '';
            return formatCurrency(value);
        };

        // â‘¤ æœˆæ¬¡CFãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæœˆ/å…¥é‡‘/å‡ºé‡‘/netCF/ç¾é‡‘æ®‹é«˜ï¼‰
        const MonthlyCFTable = ({ data, year, isGroup = false }) => (
            <div className={`rounded-lg shadow-md overflow-hidden ${isGroup ? 'bg-white/10 backdrop-blur text-white' : 'bg-white'}`}>
                <h3 className={`font-bold p-3 ${isGroup ? 'text-white' : 'text-slate-800'}`}>
                    ğŸ“… {year}å¹´åº¦ æœˆæ¬¡ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼
                </h3>
                <div className="overflow-x-auto max-h-64 overflow-y-auto">
                    <table className="w-full text-sm">
                        <thead>
                            <tr className={`${isGroup ? 'bg-white/20' : 'bg-slate-100'}`}>
                                <th className="px-2 py-2 text-left font-semibold">æœˆ</th>
                                <th className="px-2 py-2 text-right font-semibold">å…¥é‡‘</th>
                                <th className="px-2 py-2 text-right font-semibold">å‡ºé‡‘</th>
                                <th className="px-2 py-2 text-right font-semibold">netCF</th>
                                <th className="px-2 py-2 text-right font-semibold">ç¾é‡‘æ®‹é«˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((row, i) => (
                                <tr key={i} className={`border-t ${isGroup ? 'border-white/20' : 'border-slate-200'}`}>
                                    <td className="px-2 py-2 font-medium">{row.month}æœˆ</td>
                                    <td className="px-2 py-2 text-right">{formatCurrency(row.inflow)}å††</td>
                                    <td className="px-2 py-2 text-right">{formatCurrency(row.outflow)}å††</td>
                                    <td className={`px-2 py-2 text-right font-semibold ${row.netCF >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {row.netCF >= 0 ? '+' : ''}{formatCurrency(row.netCF)}å††
                                    </td>
                                    <td className={`px-2 py-2 text-right font-bold ${row.balance >= 0 ? (isGroup ? 'text-green-300' : 'text-green-600') : (isGroup ? 'text-red-300' : 'text-red-600')}`}>
                                        {formatCurrency(row.balance)}å††
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        // â‘¤ ç¾é‡‘æ®‹é«˜æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼ˆç°¡æ˜“SVGãƒ»å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã—ï¼‰
        const CashFlowChart = ({ data, year, isGroup = false }) => {
            const values = data.map(d => d.balance);
            const min = Math.min(0, ...values);
            const max = Math.max(0, ...values);
            const range = max - min || 1;
            const h = 120, w = 100;
            const pts = values.map((v, i) => {
                const x = (i / 11) * (w - 20) + 10;
                const y = h - 20 - ((v - min) / range) * (h - 40);
                return `${x},${y}`;
            }).join(' ');
            const lineColor = isGroup ? '#93c5fd' : '#3b82f6';
            const zeroColor = isGroup ? 'rgba(255,255,255,0.5)' : '#e2e8f0';
            return (
                <div className={`rounded-lg shadow-md p-4 ${isGroup ? 'bg-white/10 backdrop-blur text-white' : 'bg-white'}`}>
                    <h3 className={`font-bold mb-2 ${isGroup ? 'text-white' : 'text-slate-800'}`}>ğŸ“ˆ ç¾é‡‘æ®‹é«˜æ¨ç§»</h3>
                    <svg viewBox={`0 0 ${w + 20} ${h + 30}`} className="w-full max-w-sm">
                        <line x1="10" y1={h/2} x2={w+10} y2={h/2} stroke={zeroColor} strokeDasharray="2,2" />
                        <polyline points={pts} fill="none" stroke={lineColor} strokeWidth="2" />
                        {values.map((v, i) => (
                            <circle key={i} cx={(i/11)*(w-20)+10} cy={h-20-((v-min)/range)*(h-40)} r="3" fill={v >= 0 ? (isGroup ? '#86efac' : '#22c55e') : (isGroup ? '#fca5a5' : '#ef4444')} />
                        ))}
                    </svg>
                    <div className={`flex justify-between text-xs mt-1 ${isGroup ? 'text-white/80' : 'text-slate-500'}`}>
                        <span>1æœˆ</span><span>12æœˆ</span>
                    </div>
                </div>
            );
        };

        // KPIã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const KPICard = ({ title, value, highlight = false, isGroup = false }) => {
            const isPositive = value >= 0;
            const colorClass = isPositive ? 'text-green-600' : 'text-red-600';
            
            return (
                <div className={`bg-white rounded-lg shadow-md p-4 ${highlight ? 'ring-2 ring-blue-500' : ''}`}>
                    <div className="text-sm text-slate-600 mb-1">{title}</div>
                    <div className={`text-2xl font-bold ${colorClass} ${isGroup ? 'text-3xl' : ''}`}>
                        {isPositive ? '+' : ''}{formatCurrency(value)}
                        <span className="text-sm font-normal ml-1">å††</span>
                    </div>
                </div>
            );
        };

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const App = () => {
            // çŠ¶æ…‹ç®¡ç†
            const [year, setYear] = useState(2025);
            const [month, setMonth] = useState(1);
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [companies, setCompanies] = useState([createInitialCompany(1, 'ä¼šç¤¾1', DEFAULT_SETTINGS)]);
            const [selectedCompanyId, setSelectedCompanyId] = useState(1);
            const [showGroupView, setShowGroupView] = useState(true);
            const [nextId, setNextId] = useState(2);

            // LocalStorage ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆv1/v2/v3ã‹ã‚‰ã®ç§»è¡Œå¯¾å¿œï¼‰
            useEffect(() => {
                try {
                    let saved = localStorage.getItem(STORAGE_KEY);
                    if (!saved) saved = localStorage.getItem('tax_simulator_data_v5');
                    if (!saved) saved = localStorage.getItem('tax_simulator_data_v4');
                    if (!saved) saved = localStorage.getItem('tax_simulator_data_v3');
                    if (!saved) saved = localStorage.getItem('tax_simulator_data_v2');
                    if (!saved) saved = localStorage.getItem('tax_simulator_data_v1');
                    if (saved) {
                        const data = JSON.parse(saved);
                        setYear(data.year || 2025);
                        setMonth(data.month || 1);
                        setSettings({ ...DEFAULT_SETTINGS, ...data.settings });
                        // å¤ã„ãƒ‡ãƒ¼ã‚¿ã¨ã®äº’æ›æ€§ã®ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                        const companiesWithDefaults = (data.companies || [createInitialCompany(1, 'ä¼šç¤¾1')]).map(company => ({
                            ...company,
                            // å½¹å“¡å ±é…¬
                            executiveCompensation: company.executiveCompensation || 0,
                            executiveCompensationInputMode: company.executiveCompensationInputMode || 'manual',
                            executiveCompensationPercent: company.executiveCompensationPercent || 10,
                            // çµ¦ä¸
                            salary: company.salary || 0,
                            salaryInputMode: company.salaryInputMode || 'manual',
                            salaryPercent: company.salaryPercent || 15,
                            // å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰
                            outsourcingWithInvoice: company.outsourcingWithInvoice || 0,
                            outsourcingWithInvoiceInputMode: company.outsourcingWithInvoiceInputMode || 'manual',
                            outsourcingWithInvoicePercent: company.outsourcingWithInvoicePercent || 5,
                            // å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼‰
                            outsourcingWithoutInvoice: company.outsourcingWithoutInvoice || 0,
                            outsourcingWithoutInvoiceInputMode: company.outsourcingWithoutInvoiceInputMode || 'manual',
                            outsourcingWithoutInvoicePercent: company.outsourcingWithoutInvoicePercent || 0,
                            // è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰
                            expenseWithInvoiceInputMode: company.expenseWithInvoiceInputMode || 'manual',
                            expenseWithInvoicePercent: company.expenseWithInvoicePercent || 20,
                            // è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼‰
                            expenseWithoutInvoiceInputMode: company.expenseWithoutInvoiceInputMode || 'manual',
                            expenseWithoutInvoicePercent: company.expenseWithoutInvoicePercent || 5,
                            // ç¤¾ä¿æ–™ç‡
                            executiveSocialInsurancePercent: company.executiveSocialInsurancePercent || 15,
                            salarySocialInsurancePercent: company.salarySocialInsurancePercent || 15,
                            // æœŸé¦–ç¾é‡‘ãƒ»ã‚µã‚¤ãƒˆãƒ»ç¨é‡‘æ”¯æ‰•æœˆ
                            beginningCash: company.beginningCash ?? 0,
                            receivablesDay0: company.receivablesDay0 ?? 0,
                            receivablesDay30: company.receivablesDay30 ?? 0,
                            receivablesDay60: company.receivablesDay60 ?? 0,
                            receivablesDay90: company.receivablesDay90 ?? 0,
                            salesPaymentDays: company.salesPaymentDays ?? 0,
                            expensePaymentDays: company.expensePaymentDays ?? 0,
                            salaryPaymentTerms: company.salaryPaymentTerms || 'current',
                            corporateTaxMonth: company.corporateTaxMonth ?? 3,
                            consumptionTaxMonth: company.consumptionTaxMonth ?? 3,
                            previousPeriodConsumptionTax: company.previousPeriodConsumptionTax ?? 0,
                            businessType: company.businessType || 'corporation',
                            taxPeriodStartMonth: company.taxPeriodStartMonth ?? 4,
                            hasExtension: company.hasExtension ?? false,
                            previousPeriodCorporateTax: company.previousPeriodCorporateTax ?? 0,
                            previousFiscalMonths: company.previousFiscalMonths ?? 12,
                            capitalAmount: company.capitalAmount ?? 0,
                            isLargeCorpSubsidiary: company.isLargeCorpSubsidiary ?? false,
                            entityType: company.entityType || 'æ™®é€šæ³•äºº',
                            interimIncome: company.interimIncome ?? 0,
                            laborInsuranceIndustry: company.laborInsuranceIndustry || 'retail',
                            prevYearConfirmedWages: company.prevYearConfirmedWages ?? 0,
                            prevYearEstimatedWages: company.prevYearEstimatedWages ?? 0,
                            currYearEstimatedWages: company.currYearEstimatedWages ?? 0,
                            laborInsuranceDelegation: company.laborInsuranceDelegation ?? false
                        }));
                        setCompanies(companiesWithDefaults);
                        setSelectedCompanyId(data.selectedCompanyId || 1);
                        setShowGroupView(data.showGroupView !== undefined ? data.showGroupView : true);
                        setNextId(data.nextId || 2);
                    }
                } catch (e) {
                    console.error('Failed to load from localStorage', e);
                }
            }, []);

            // LocalStorage ã¸ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            useEffect(() => {
                try {
                    const data = {
                        year,
                        month,
                        settings,
                        companies,
                        selectedCompanyId,
                        showGroupView,
                        nextId
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error('Failed to save to localStorage', e);
                }
            }, [year, month, settings, companies, selectedCompanyId, showGroupView, nextId]);

            // é¸æŠä¸­ã®ä¼šç¤¾ã‚’å–å¾—
            const selectedCompany = companies.find(c => c.id === selectedCompanyId) || companies[0];

            // ä¼šç¤¾è¿½åŠ 
            const addCompany = () => {
                const newCompany = createInitialCompany(nextId, `ä¼šç¤¾${nextId}`, settings);
                setCompanies([...companies, newCompany]);
                setSelectedCompanyId(nextId);
                setNextId(nextId + 1);
            };

            // ä¼šç¤¾å‰Šé™¤ï¼ˆæœ€ä½1ç¤¾ã¯æ®‹ã™ï¼‰
            const deleteCompany = (id) => {
                if (companies.length <= 1) {
                    alert('æœ€ä½1ç¤¾ã¯å¿…è¦ã§ã™');
                    return;
                }
                const newCompanies = companies.filter(c => c.id !== id);
                setCompanies(newCompanies);
                if (selectedCompanyId === id) {
                    setSelectedCompanyId(newCompanies[0].id);
                }
            };

            // ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            const updateCompany = (id, updates) => {
                setCompanies(companies.map(c => 
                    c.id === id ? { ...c, ...updates } : c
                ));
            };

            // ãƒªã‚»ãƒƒãƒˆ
            const resetAll = () => {
                if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    setCompanies([createInitialCompany(1, 'ä¼šç¤¾1')]);
                    setSelectedCompanyId(1);
                    setNextId(2);
                    setYear(2025);
                    setMonth(1);
                    setShowGroupView(true);
                }
            };

            // æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
            const createNewGroup = () => {
                if (confirm('æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿï¼ˆç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                    resetAll();
                }
            };

            const groupKPI = calculateGroupTotal(companies, year, month, settings);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
                    {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                    <header className="bg-gradient-to-r from-blue-900 to-blue-800 text-white shadow-lg">
                        <div className="container mx-auto px-4 py-6">
                            <div className="flex flex-wrap items-center justify-between gap-4">
                                <h1 className="text-2xl md:text-3xl font-bold">çµŒå–¶ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«</h1>
                                
                                <div className="flex flex-wrap items-center gap-3">
                                    {/* å¹´åº¦ãƒ»æœˆé¸æŠ */}
                                    <select 
                                        value={year}
                                        onChange={(e) => setYear(Number(e.target.value))}
                                        className="px-4 py-2 rounded-lg bg-white text-slate-800 font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    >
                                        <option value={2025}>2025å¹´åº¦</option>
                                        <option value={2026}>2026å¹´åº¦</option>
                                        <option value={2027}>2027å¹´åº¦</option>
                                        <option value={2028}>2028å¹´åº¦</option>
                                        <option value={2029}>2029å¹´åº¦</option>
                                        <option value={2030}>2030å¹´åº¦</option>
                                    </select>
                                    <select 
                                        value={month}
                                        onChange={(e) => setMonth(Number(e.target.value))}
                                        className="px-4 py-2 rounded-lg bg-white text-slate-800 font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    >
                                        <option value={1}>1æœˆ</option>
                                        <option value={2}>2æœˆ</option>
                                        <option value={3}>3æœˆ</option>
                                        <option value={4}>4æœˆ</option>
                                        <option value={5}>5æœˆ</option>
                                        <option value={6}>6æœˆ</option>
                                        <option value={7}>7æœˆ</option>
                                        <option value={8}>8æœˆ</option>
                                        <option value={9}>9æœˆ</option>
                                        <option value={10}>10æœˆ</option>
                                        <option value={11}>11æœˆ</option>
                                        <option value={12}>12æœˆ</option>
                                    </select>

                                    {/* ã‚°ãƒ«ãƒ¼ãƒ—ãƒ“ãƒ¥ãƒ¼ãƒˆã‚°ãƒ« */}
                                    <button
                                        onClick={() => setShowGroupView(!showGroupView)}
                                        className={`px-4 py-2 rounded-lg font-semibold shadow-md transition-colors ${
                                            showGroupView 
                                                ? 'bg-green-500 hover:bg-green-600' 
                                                : 'bg-slate-300 hover:bg-slate-400 text-slate-700'
                                        }`}
                                    >
                                        {showGroupView ? 'âœ“ ' : ''}ã‚°ãƒ«ãƒ¼ãƒ—åˆç®—
                                    </button>

                                    {/* ä¼šç¤¾è¿½åŠ  */}
                                    <button
                                        onClick={addCompany}
                                        className="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 rounded-lg font-semibold shadow-md transition-colors"
                                    >
                                        + ä¼šç¤¾è¿½åŠ 
                                    </button>

                                    {/* æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ— */}
                                    <button
                                        onClick={createNewGroup}
                                        className="px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg font-semibold shadow-md transition-colors"
                                    >
                                        æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—
                                    </button>

                                    {/* è¨­å®š */}
                                    <button
                                        onClick={() => setShowSettingsModal(true)}
                                        className="px-4 py-2 bg-slate-600 hover:bg-slate-700 rounded-lg font-semibold shadow-md transition-colors"
                                    >
                                        âš™ï¸ è¨­å®š
                                    </button>

                                    {/* ãƒªã‚»ãƒƒãƒˆ */}
                                    <button
                                        onClick={resetAll}
                                        className="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg font-semibold shadow-md transition-colors"
                                    >
                                        ãƒªã‚»ãƒƒãƒˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowSettingsModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-slate-800 mb-4">âš™ï¸ æ©Ÿèƒ½è¨­å®š</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">æ¶ˆè²»ç¨ç‡ï¼ˆ%ï¼‰</label>
                                        <input
                                            type="number"
                                            value={settings.consumptionTaxRate ?? 10}
                                            onChange={(e) => setSettings(s => ({ ...s, consumptionTaxRate: Number(e.target.value) || 10 }))}
                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500"
                                            min="0"
                                            max="100"
                                            step="0.1"
                                        />
                                        <p className="text-xs text-slate-500 mt-1">â€»æ¨™æº–ç¨ç‡10%ã€è»½æ¸›ç¨ç‡8%ãªã©</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">æ–°è¦ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¤¾ä¿æ–™ç‡ï¼ˆ%ï¼‰</label>
                                        <input
                                            type="number"
                                            value={settings.defaultSocialInsuranceRate ?? 15}
                                            onChange={(e) => setSettings(s => ({ ...s, defaultSocialInsuranceRate: Number(e.target.value) || 15 }))}
                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500"
                                            min="0"
                                            max="100"
                                            step="0.1"
                                        />
                                    </div>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={settings.showIntermediateTaxSection ?? true}
                                            onChange={(e) => setSettings(s => ({ ...s, showIntermediateTaxSection: e.target.checked }))}
                                            className="rounded"
                                        />
                                        <span className="text-sm text-slate-700">ä¸­é–“ç”³å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º</span>
                                    </label>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={settings.showMonthlyCFSection ?? true}
                                            onChange={(e) => setSettings(s => ({ ...s, showMonthlyCFSection: e.target.checked }))}
                                            className="rounded"
                                        />
                                        <span className="text-sm text-slate-700">æœˆæ¬¡ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º</span>
                                    </label>
                                </div>
                                <div className="mt-6 flex justify-end">
                                    <button onClick={() => setShowSettingsModal(false)} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                                        é–‰ã˜ã‚‹
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
                    <div className="container mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            
                            {/* å·¦ã‚«ãƒ©ãƒ ï¼šä¼šç¤¾ãƒªã‚¹ãƒˆ */}
                            <div className="lg:col-span-3">
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">ä¼šç¤¾ãƒªã‚¹ãƒˆ</h2>
                                    <div className="space-y-3 custom-scrollbar max-h-[calc(100vh-250px)] overflow-y-auto">
                                        {companies.map(company => {
                                            const kpi = calculateKPI(company, year, month, settings);
                                            const isSelected = company.id === selectedCompanyId;
                                            
                                            return (
                                                <div
                                                    key={company.id}
                                                    className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                                        isSelected 
                                                            ? 'border-blue-500 bg-blue-50 shadow-md' 
                                                            : 'border-slate-200 hover:border-blue-300 hover:shadow'
                                                    }`}
                                                    onClick={() => setSelectedCompanyId(company.id)}
                                                >
                                                    <div className="flex justify-between items-start mb-2">
                                                        <h3 className="font-bold text-lg text-slate-800">{company.name}</h3>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                deleteCompany(company.id);
                                                            }}
                                                            className="text-red-500 hover:text-red-700 text-sm font-semibold"
                                                        >
                                                            å‰Šé™¤
                                                        </button>
                                                    </div>
                                                    <div className="text-xs space-y-1 text-slate-600">
                                                        <div>äººä»¶è²»è¨ˆ: <span className="text-blue-600">{formatCurrency(kpi.totalLaborCost)}å††</span></div>
                                                        <div>ç¤¾ä¿è¨ˆ: <span className="text-purple-600">{formatCurrency(kpi.totalSocialInsuranceCost)}å††</span></div>
                                                        <div>å–¶æ¥­åˆ©ç›Š: <span className={kpi.operatingProfit >= 0 ? 'text-green-600' : 'text-red-600'}>{formatCurrency(kpi.operatingProfit)}å††</span></div>
                                                        <div>ç¨å¼•å¾Œ: <span className={kpi.netProfit >= 0 ? 'text-green-600' : 'text-red-600'}>{formatCurrency(kpi.netProfit)}å††</span></div>
                                                        <div>ã‚­ãƒ£ãƒƒã‚·ãƒ¥: <span className={kpi.actualCash >= 0 ? 'text-green-600' : 'text-red-600'}>{formatCurrency(kpi.actualCash)}å††</span></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>

                            {/* ä¸­å¤®ã‚«ãƒ©ãƒ ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */}
                            <div className="lg:col-span-5">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                                        <input
                                            type="text"
                                            value={selectedCompany.name}
                                            onChange={(e) => updateCompany(selectedCompany.id, { name: e.target.value })}
                                            className="text-2xl font-bold text-slate-800 bg-transparent border-b-2 border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none transition-colors px-2"
                                        />
                                    </div>

                                    <div className="space-y-6 custom-scrollbar max-h-[calc(100vh-250px)] overflow-y-auto pr-2">
                                        {/* èª²ç¨äº‹æ¥­è€…ãƒˆã‚°ãƒ« */}
                                        <div className="bg-slate-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-slate-700 mb-3">å‰ææ¡ä»¶</h3>
                                            <div className="space-y-3">
                                                <label className="flex items-center justify-between">
                                                    <span className="text-slate-700">èª²ç¨äº‹æ¥­è€…</span>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { isTaxable: !selectedCompany.isTaxable })}
                                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                                                            selectedCompany.isTaxable ? 'bg-blue-600' : 'bg-slate-300'
                                                        }`}
                                                    >
                                                        <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                            selectedCompany.isTaxable ? 'translate-x-6' : 'translate-x-1'
                                                        }`} />
                                                    </button>
                                                </label>

                                                <label className="flex items-center justify-between">
                                                    <span className="text-slate-700">ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²</span>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { hasInvoice: !selectedCompany.hasInvoice })}
                                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                                                            selectedCompany.hasInvoice ? 'bg-blue-600' : 'bg-slate-300'
                                                        }`}
                                                    >
                                                        <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                            selectedCompany.hasInvoice ? 'translate-x-6' : 'translate-x-1'
                                                        }`} />
                                                    </button>
                                                </label>
                                            </div>
                                            {/* å…ç¨äº‹æ¥­è€…ç­‰ã‹ã‚‰ã®ä»•å…¥ã‚Œã«ãŠã‘ã‚‹çµŒéæªç½®ï¼ˆå›³è¡¨1ï¼‰ */}
                                            <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                                <p className="text-xs font-semibold text-amber-800 mb-2">å…ç¨äº‹æ¥­è€…ç­‰ã‹ã‚‰ã®ä»•å…¥ã‚Œã«ãŠã‘ã‚‹çµŒéæªç½®</p>
                                                <ul className="text-xs text-amber-900 space-y-1">
                                                    <li>â€¢ 2023/10ï½2026/9: <strong>80%</strong>æ§é™¤å¯èƒ½</li>
                                                    <li>â€¢ 2026/10ï½2029/9: <strong>50%</strong>æ§é™¤å¯èƒ½</li>
                                                    <li>â€¢ 2029/10ï½: æ§é™¤ä¸å¯</li>
                                                </ul>
                                                <p className="text-xs text-amber-700 mt-2">â€»ã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ã®è²©ç®¡è²»ãƒ»å¤–æ³¨è²»ã¯ä¸Šè¨˜çµŒéæªç½®ã«åŸºã¥ãè¨ˆç®—</p>
                                                <p className="text-xs text-amber-600 mt-1">é¸æŠæ—¥ä»˜ {year}å¹´{month}æœˆ: {getTaxExemptDeductionRate(year, month) * 100}%æ§é™¤é©ç”¨</p>
                                            </div>
                                        </div>

                                        {/* â‘  æœŸé¦–ç¾é‡‘ãƒ»å£²æ›é‡‘å…¥é‡‘ */}
                                        <div className="bg-slate-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-slate-700 mb-3">æœŸé¦–ç¾é‡‘ãƒ»å£²æ›é‡‘å…¥é‡‘</h3>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">æœŸé¦–ç¾é‡‘ï¼ˆå¹´åˆæ®‹é«˜ãƒ»å††ï¼‰</label>
                                                    <input
                                                        type="text"
                                                        value={formatInputValue(selectedCompany.beginningCash)}
                                                        onChange={(e) => updateCompany(selectedCompany.id, { beginningCash: parseNumber(e.target.value) })}
                                                        className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                        placeholder="0"
                                                    />
                                                    <p className="text-xs text-slate-500 mt-1">â€»æœˆæ¬¡CFã®åˆæœŸæ®‹é«˜</p>
                                                </div>
                                                <div className="pt-3 border-t border-slate-200">
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">æœŸé¦–å£²æ›é‡‘ã®å…¥é‡‘ï¼ˆã‚µã‚¤ãƒˆåˆ¥ãƒ»å††ï¼‰</label>
                                                    <p className="text-xs text-slate-500 mb-2">â€»1ï½4æœˆã«ãã‚Œãã‚Œå…¥é‡‘è¨ˆä¸Š</p>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div>
                                                            <label className="block text-xs text-slate-600 mb-1">0æ—¥ï¼ˆ1æœˆå…¥é‡‘ï¼‰</label>
                                                            <input type="text" value={formatInputValue(selectedCompany.receivablesDay0)} onChange={(e) => updateCompany(selectedCompany.id, { receivablesDay0: parseNumber(e.target.value) })} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-right text-sm" placeholder="0" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-slate-600 mb-1">30æ—¥ï¼ˆ2æœˆå…¥é‡‘ï¼‰</label>
                                                            <input type="text" value={formatInputValue(selectedCompany.receivablesDay30)} onChange={(e) => updateCompany(selectedCompany.id, { receivablesDay30: parseNumber(e.target.value) })} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-right text-sm" placeholder="0" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-slate-600 mb-1">60æ—¥ï¼ˆ3æœˆå…¥é‡‘ï¼‰</label>
                                                            <input type="text" value={formatInputValue(selectedCompany.receivablesDay60)} onChange={(e) => updateCompany(selectedCompany.id, { receivablesDay60: parseNumber(e.target.value) })} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-right text-sm" placeholder="0" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-slate-600 mb-1">90æ—¥ï¼ˆ4æœˆå…¥é‡‘ï¼‰</label>
                                                            <input type="text" value={formatInputValue(selectedCompany.receivablesDay90)} onChange={(e) => updateCompany(selectedCompany.id, { receivablesDay90: parseNumber(e.target.value) })} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-right text-sm" placeholder="0" />
                                                        </div>
                                                    </div>
                                                    <p className="text-xs text-slate-500 mt-2">å£²æ›é‡‘åˆè¨ˆ: {formatCurrency((selectedCompany.receivablesDay0 || 0) + (selectedCompany.receivablesDay30 || 0) + (selectedCompany.receivablesDay60 || 0) + (selectedCompany.receivablesDay90 || 0))}å††</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* â‘¡ æ”¯æ‰•ã„ã‚µã‚¤ãƒˆï¼ˆæœˆæ¬¡CFç”¨ï¼‰ */}
                                        <div className="bg-teal-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-slate-700 mb-3">æ”¯æ‰•ã„ã‚µã‚¤ãƒˆï¼ˆæœˆæ¬¡CFç”¨ï¼‰</h3>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">A) å£²ä¸Šã®å…¥é‡‘ã‚µã‚¤ãƒˆ</label>
                                                    <select
                                                        value={selectedCompany.salesPaymentDays ?? 0}
                                                        onChange={(e) => updateCompany(selectedCompany.id, { salesPaymentDays: Number(e.target.value) })}
                                                        className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg"
                                                    >
                                                        <option value={0}>0æ—¥ï¼ˆå½“æœˆå…¥é‡‘ï¼‰</option>
                                                        <option value={30}>30æ—¥ï¼ˆç¿Œæœˆï¼‰</option>
                                                        <option value={60}>60æ—¥ï¼ˆ2ãƒ¶æœˆå¾Œï¼‰</option>
                                                        <option value={90}>90æ—¥ï¼ˆ3ãƒ¶æœˆå¾Œï¼‰</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">B) è²©ç®¡è²»ã®æ”¯æ‰•ã„ã‚µã‚¤ãƒˆ</label>
                                                    <select
                                                        value={selectedCompany.expensePaymentDays ?? 0}
                                                        onChange={(e) => updateCompany(selectedCompany.id, { expensePaymentDays: Number(e.target.value) })}
                                                        className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg"
                                                    >
                                                        <option value={0}>0æ—¥ï¼ˆå½“æœˆå‡ºé‡‘ï¼‰</option>
                                                        <option value={30}>30æ—¥ï¼ˆç¿Œæœˆï¼‰</option>
                                                        <option value={60}>60æ—¥ï¼ˆ2ãƒ¶æœˆå¾Œï¼‰</option>
                                                        <option value={90}>90æ—¥ï¼ˆ3ãƒ¶æœˆå¾Œï¼‰</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">C) çµ¦ä¸ã®æ”¯æ‰•ã„ã‚µã‚¤ãƒˆ</label>
                                                    <select
                                                        value={selectedCompany.salaryPaymentTerms || 'current'}
                                                        onChange={(e) => updateCompany(selectedCompany.id, { salaryPaymentTerms: e.target.value })}
                                                        className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg"
                                                    >
                                                        <option value="current">å½“æœˆæœ«ï¼ˆå½“æœˆå‡ºé‡‘ï¼‰</option>
                                                        <option value="next">ç¿Œæœˆæœ«ï¼ˆç¿Œæœˆå‡ºé‡‘ï¼‰</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {/* â‘¢ ç¨é‡‘ã®æ”¯æ‰•æœˆ */}
                                        <div className="bg-rose-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-slate-700 mb-3">ç¨é‡‘ã®æ”¯æ‰•æœˆ</h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">æ³•äººç¨æ”¯æ‰•æœˆ</label>
                                                    <select
                                                        value={selectedCompany.corporateTaxMonth ?? 3}
                                                        onChange={(e) => updateCompany(selectedCompany.id, { corporateTaxMonth: Number(e.target.value) })}
                                                        className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg"
                                                    >
                                                        {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                                            <option key={m} value={m}>{m}æœˆ</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">æ¶ˆè²»ç¨æ”¯æ‰•æœˆ</label>
                                                    <select
                                                        value={selectedCompany.consumptionTaxMonth ?? 3}
                                                        onChange={(e) => updateCompany(selectedCompany.id, { consumptionTaxMonth: Number(e.target.value) })}
                                                        className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg"
                                                    >
                                                        {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                                            <option key={m} value={m}>{m}æœˆ</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {settings.showIntermediateTaxSection !== false && (
                                        <>
                                        {/* ä¸­é–“æ¶ˆè²»ç¨ç”³å‘Šï¼ˆå…¥åŠ›ï¼‰ */}
                                        <div className="bg-violet-50 p-4 rounded-lg border border-violet-200">
                                            <h3 className="font-semibold text-slate-700 mb-3">ä¸­é–“æ¶ˆè²»ç¨ç”³å‘Š</h3>
                                            <p className="text-xs text-slate-600 mb-3">â€»ç›´å‰èª²ç¨æœŸé–“ã®ç¢ºå®šæ¶ˆè²»ç¨é¡ï¼ˆåœ°æ–¹æ¶ˆè²»ç¨é™¤ãï¼‰ã§åˆ¤å®š</p>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">ç›´å‰ã®ç¢ºå®šæ¶ˆè²»ç¨é¡ï¼ˆå›½ç¨ã®ã¿ï¼‰å††</label>
                                                    <input type="text" value={formatInputValue(selectedCompany.previousPeriodConsumptionTax)} onChange={(e) => updateCompany(selectedCompany.id, { previousPeriodConsumptionTax: parseNumber(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-violet-500 focus:outline-none text-right" placeholder="0" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">äº‹æ¥­è€…åŒºåˆ†</label>
                                                    <select value={selectedCompany.businessType || 'corporation'} onChange={(e) => updateCompany(selectedCompany.id, { businessType: e.target.value })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg">
                                                        <option value="individual">å€‹äººäº‹æ¥­è€…</option>
                                                        <option value="corporation">æ³•äºº</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">èª²ç¨æœŸé–“é–‹å§‹æœˆ</label>
                                                    <select value={selectedCompany.taxPeriodStartMonth ?? 4} onChange={(e) => updateCompany(selectedCompany.id, { taxPeriodStartMonth: Number(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg">
                                                        {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => <option key={m} value={m}>{m}æœˆ</option>)}
                                                    </select>
                                                </div>
                                                {selectedCompany.businessType === 'corporation' && (
                                                    <label className="flex items-center gap-2">
                                                        <input type="checkbox" checked={selectedCompany.hasExtension ?? false} onChange={(e) => updateCompany(selectedCompany.id, { hasExtension: e.target.checked })} className="rounded" />
                                                        <span className="text-sm text-slate-700">ç¢ºå®šç”³å‘ŠæœŸé™å»¶é•·ç‰¹ä¾‹ã‚’å—ã‘ã¦ã„ã‚‹</span>
                                                    </label>
                                                )}
                                            </div>
                                        </div>

                                        {/* æ³•äººç¨ä¸­é–“ç”³å‘Šï¼ˆå…¥åŠ›ï¼‰ */}
                                        <div className="bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                                            <h3 className="font-semibold text-slate-700 mb-3">æ³•äººç¨ä¸­é–“ç”³å‘Š</h3>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">ç›´å‰äº‹æ¥­å¹´åº¦ã®ç¢ºå®šæ³•äººç¨é¡ï¼ˆå††ï¼‰</label>
                                                    <input type="text" value={formatInputValue(selectedCompany.previousPeriodCorporateTax)} onChange={(e) => updateCompany(selectedCompany.id, { previousPeriodCorporateTax: parseNumber(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-emerald-500 focus:outline-none text-right" placeholder="0" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">ç›´å‰äº‹æ¥­å¹´åº¦ã®æœˆæ•°</label>
                                                    <select value={selectedCompany.previousFiscalMonths ?? 12} onChange={(e) => updateCompany(selectedCompany.id, { previousFiscalMonths: Number(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg">
                                                        <option value={12}>12ã‹æœˆ</option>
                                                        <option value={6}>6ã‹æœˆ</option>
                                                        <option value={3}>3ã‹æœˆ</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">è³‡æœ¬é‡‘é¡ï¼ˆå††ï¼‰</label>
                                                    <input type="text" value={formatInputValue(selectedCompany.capitalAmount)} onChange={(e) => updateCompany(selectedCompany.id, { capitalAmount: parseNumber(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-emerald-500 focus:outline-none text-right" placeholder="0" />
                                                    <p className="text-xs text-slate-500 mt-1">â€»1å„„å††è¶…ã§å¤§æ³•äººç¨ç‡</p>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">æ³•äººåŒºåˆ†</label>
                                                    <select value={selectedCompany.entityType || 'æ™®é€šæ³•äºº'} onChange={(e) => updateCompany(selectedCompany.id, { entityType: e.target.value })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg">
                                                        <option value="æ™®é€šæ³•äºº">æ™®é€šæ³•äºº</option>
                                                        <option value="åŒ»ç™‚æ³•äºº">ç‰¹å®šã®åŒ»ç™‚æ³•äºº</option>
                                                    </select>
                                                </div>
                                                <label className="flex items-center gap-2">
                                                    <input type="checkbox" checked={selectedCompany.isLargeCorpSubsidiary ?? false} onChange={(e) => updateCompany(selectedCompany.id, { isLargeCorpSubsidiary: e.target.checked })} className="rounded" />
                                                    <span className="text-sm text-slate-700">å¤§æ³•äºº100%å­ä¼šç¤¾</span>
                                                </label>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">ä»®æ±ºç®—ç”¨æ‰€å¾—ï¼ˆ6ã‹æœˆåˆ†ãƒ»å††ï¼‰</label>
                                                    <input type="text" value={formatInputValue(selectedCompany.interimIncome)} onChange={(e) => updateCompany(selectedCompany.id, { interimIncome: parseNumber(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-emerald-500 focus:outline-none text-right" placeholder="0" />
                                                    <p className="text-xs text-slate-500 mt-1">â€»å…¥åŠ›æ™‚ã®ã¿ä»®æ±ºç®—æ–¹å¼ã®ç¨é¡ã‚’è¨ˆç®—</p>
                                                </div>
                                            </div>
                                        </div>
                                        </>
                                        )}

                                        {/* åŠ´åƒä¿é™ºå¹´åº¦æ›´æ–°ï¼ˆå…¥åŠ›ï¼‰ */}
                                        <div className="bg-sky-50 p-4 rounded-lg border border-sky-200">
                                            <h3 className="font-semibold text-slate-700 mb-3">åŠ´åƒä¿é™ºå¹´åº¦æ›´æ–°</h3>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">1. äº‹æ¥­ã®ç¨®é¡</label>
                                                    <select value={selectedCompany.laborInsuranceIndustry || 'retail'} onChange={(e) => updateCompany(selectedCompany.id, { laborInsuranceIndustry: e.target.value })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg">
                                                        {Object.entries(LABOR_INDUSTRY_RATES).map(([k, v]) => <option key={k} value={k}>{v.name}</option>)}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">2. å‰å¹´åº¦ç¢ºå®šè³ƒé‡‘ç·é¡ï¼ˆå††ï¼‰</label>
                                                    <input type="text" value={formatInputValue(selectedCompany.prevYearConfirmedWages)} onChange={(e) => updateCompany(selectedCompany.id, { prevYearConfirmedWages: parseNumber(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-sky-500 focus:outline-none text-right" placeholder="0" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">3. å‰å¹´åº¦æ¦‚ç®—è³ƒé‡‘ï¼ˆå††ãƒ»ä»»æ„ï¼‰</label>
                                                    <input type="text" value={formatInputValue(selectedCompany.prevYearEstimatedWages)} onChange={(e) => updateCompany(selectedCompany.id, { prevYearEstimatedWages: parseNumber(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-sky-500 focus:outline-none text-right" placeholder="0" />
                                                    <p className="text-xs text-slate-500 mt-1">â€»æœªå…¥åŠ›æ™‚ã¯å‰å¹´åº¦ç¢ºå®šé¡ã§ç®—å‡º</p>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">4. å½“å¹´åº¦æ¦‚ç®—è³ƒé‡‘ç·é¡è¦‹è¾¼é¡ï¼ˆå††ï¼‰</label>
                                                    <input type="text" value={formatInputValue(selectedCompany.currYearEstimatedWages)} onChange={(e) => updateCompany(selectedCompany.id, { currYearEstimatedWages: parseNumber(e.target.value) })} className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-sky-500 focus:outline-none text-right" placeholder="0" />
                                                </div>
                                                <label className="flex items-center gap-2">
                                                    <input type="checkbox" checked={selectedCompany.laborInsuranceDelegation ?? false} onChange={(e) => updateCompany(selectedCompany.id, { laborInsuranceDelegation: e.target.checked })} className="rounded" />
                                                    <span className="text-sm text-slate-700">5. åŠ´åƒä¿é™ºäº‹å‹™çµ„åˆã¸ã®å§”è¨—ã‚ã‚Š</span>
                                                </label>
                                            </div>
                                        </div>

                                        {/* æ•°å€¤å…¥åŠ› */}
                                        <div className="space-y-4">
                                            <h3 className="font-semibold text-slate-700 mb-3">æ•°å€¤å…¥åŠ›ï¼ˆç¨æŠœï¼‰</h3>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">å£²ä¸Šï¼ˆç¨æŠœï¼‰</label>
                                                <input
                                                    type="text"
                                                    value={formatInputValue(selectedCompany.revenue)}
                                                    onChange={(e) => updateCompany(selectedCompany.id, { revenue: parseNumber(e.target.value) })}
                                                    className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                    placeholder="0"
                                                />
                                            </div>

                                            {/* å½¹å“¡å ±é…¬ */}
                                            <div className="bg-indigo-50 p-4 rounded-lg">
                                                <h4 className="font-semibold text-slate-700 mb-3">å½¹å“¡å ±é…¬</h4>
                                                <div className="flex gap-2 mb-3">
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { executiveCompensationInputMode: 'manual' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.executiveCompensationInputMode === 'manual'
                                                                ? 'bg-indigo-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-indigo-400'
                                                        }`}
                                                    >
                                                        æ‰‹å…¥åŠ›
                                                    </button>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { executiveCompensationInputMode: 'percent' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.executiveCompensationInputMode === 'percent'
                                                                ? 'bg-indigo-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-indigo-400'
                                                        }`}
                                                    >
                                                        ï¼…ã§å…¥åŠ›
                                                    </button>
                                                </div>

                                                {selectedCompany.executiveCompensationInputMode === 'manual' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å½¹å“¡å ±é…¬ï¼ˆç¨æŠœï¼‰</label>
                                                        <input
                                                            type="text"
                                                            value={formatInputValue(selectedCompany.executiveCompensation)}
                                                            onChange={(e) => updateCompany(selectedCompany.id, { executiveCompensation: parseNumber(e.target.value) })}
                                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                )}

                                                {selectedCompany.executiveCompensationInputMode === 'percent' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å½¹å“¡å ±é…¬ç‡ï¼ˆå£²ä¸Šã«å¯¾ã™ã‚‹ï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.executiveCompensationPercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { executiveCompensationPercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="10"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                        <div className="mt-2 text-xs text-slate-600">
                                                            è¨ˆç®—é¡: {formatCurrency(selectedCompany.revenue * (selectedCompany.executiveCompensationPercent / 100))}å††
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="mt-2 text-xs text-purple-600 font-semibold">
                                                    ç¤¾ä¿æ¦‚ç®—: {formatCurrency((selectedCompany.executiveCompensationInputMode === 'percent' ? selectedCompany.revenue * (selectedCompany.executiveCompensationPercent / 100) : selectedCompany.executiveCompensation) * (selectedCompany.executiveSocialInsurancePercent / 100))}å††
                                                </div>
                                            </div>

                                            {/* çµ¦ä¸ */}
                                            <div className="bg-blue-50 p-4 rounded-lg">
                                                <h4 className="font-semibold text-slate-700 mb-3">çµ¦ä¸</h4>
                                                <div className="flex gap-2 mb-3">
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { salaryInputMode: 'manual' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.salaryInputMode === 'manual'
                                                                ? 'bg-blue-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-blue-400'
                                                        }`}
                                                    >
                                                        æ‰‹å…¥åŠ›
                                                    </button>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { salaryInputMode: 'percent' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.salaryInputMode === 'percent'
                                                                ? 'bg-blue-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-blue-400'
                                                        }`}
                                                    >
                                                        ï¼…ã§å…¥åŠ›
                                                    </button>
                                                </div>

                                                {selectedCompany.salaryInputMode === 'manual' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">çµ¦ä¸ï¼ˆç¨æŠœï¼‰</label>
                                                        <input
                                                            type="text"
                                                            value={formatInputValue(selectedCompany.salary)}
                                                            onChange={(e) => updateCompany(selectedCompany.id, { salary: parseNumber(e.target.value) })}
                                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                )}

                                                {selectedCompany.salaryInputMode === 'percent' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">çµ¦ä¸ç‡ï¼ˆå£²ä¸Šã«å¯¾ã™ã‚‹ï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.salaryPercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { salaryPercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="15"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                        <div className="mt-2 text-xs text-slate-600">
                                                            è¨ˆç®—é¡: {formatCurrency(selectedCompany.revenue * (selectedCompany.salaryPercent / 100))}å††
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="mt-2 text-xs text-purple-600 font-semibold">
                                                    ç¤¾ä¿æ¦‚ç®—: {formatCurrency((selectedCompany.salaryInputMode === 'percent' ? selectedCompany.revenue * (selectedCompany.salaryPercent / 100) : selectedCompany.salary) * (selectedCompany.salarySocialInsurancePercent / 100))}å††
                                                </div>
                                            </div>

                                            {/* å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰ */}
                                            <div className="bg-cyan-50 p-4 rounded-lg">
                                                <h4 className="font-semibold text-slate-700 mb-3">å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰</h4>
                                                <div className="flex gap-2 mb-3">
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { outsourcingWithInvoiceInputMode: 'manual' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.outsourcingWithInvoiceInputMode === 'manual'
                                                                ? 'bg-cyan-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-cyan-400'
                                                        }`}
                                                    >
                                                        æ‰‹å…¥åŠ›
                                                    </button>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { outsourcingWithInvoiceInputMode: 'percent' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.outsourcingWithInvoiceInputMode === 'percent'
                                                                ? 'bg-cyan-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-cyan-400'
                                                        }`}
                                                    >
                                                        ï¼…ã§å…¥åŠ›
                                                    </button>
                                                </div>

                                                {selectedCompany.outsourcingWithInvoiceInputMode === 'manual' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å¤–æ³¨è²»ï¼ˆç¨æŠœï¼‰</label>
                                                        <input
                                                            type="text"
                                                            value={formatInputValue(selectedCompany.outsourcingWithInvoice)}
                                                            onChange={(e) => updateCompany(selectedCompany.id, { outsourcingWithInvoice: parseNumber(e.target.value) })}
                                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                )}

                                                {selectedCompany.outsourcingWithInvoiceInputMode === 'percent' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å¤–æ³¨è²»ç‡ï¼ˆå£²ä¸Šã«å¯¾ã™ã‚‹ï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.outsourcingWithInvoicePercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { outsourcingWithInvoicePercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="5"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                        <div className="mt-2 text-xs text-slate-600">
                                                            è¨ˆç®—é¡: {formatCurrency(selectedCompany.revenue * (selectedCompany.outsourcingWithInvoicePercent / 100))}å††
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼‰ */}
                                            <div className="bg-pink-50 p-4 rounded-lg">
                                                <h4 className="font-semibold text-slate-700 mb-3">å¤–æ³¨è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼å…ç¨äº‹æ¥­è€…ç­‰ï¼‰</h4>
                                                <p className="text-xs text-pink-700 mb-2">â€»{year}å¹´{month}æœˆ: çµŒéæªç½®ã«ã‚ˆã‚Š{getTaxExemptDeductionRate(year, month) * 100}%æ§é™¤å¯èƒ½</p>
                                                <div className="flex gap-2 mb-3">
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { outsourcingWithoutInvoiceInputMode: 'manual' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.outsourcingWithoutInvoiceInputMode === 'manual'
                                                                ? 'bg-pink-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-pink-400'
                                                        }`}
                                                    >
                                                        æ‰‹å…¥åŠ›
                                                    </button>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { outsourcingWithoutInvoiceInputMode: 'percent' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.outsourcingWithoutInvoiceInputMode === 'percent'
                                                                ? 'bg-pink-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-pink-400'
                                                        }`}
                                                    >
                                                        ï¼…ã§å…¥åŠ›
                                                    </button>
                                                </div>

                                                {selectedCompany.outsourcingWithoutInvoiceInputMode === 'manual' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å¤–æ³¨è²»ï¼ˆç¨æŠœï¼‰</label>
                                                        <input
                                                            type="text"
                                                            value={formatInputValue(selectedCompany.outsourcingWithoutInvoice)}
                                                            onChange={(e) => updateCompany(selectedCompany.id, { outsourcingWithoutInvoice: parseNumber(e.target.value) })}
                                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                )}

                                                {selectedCompany.outsourcingWithoutInvoiceInputMode === 'percent' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å¤–æ³¨è²»ç‡ï¼ˆå£²ä¸Šã«å¯¾ã™ã‚‹ï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.outsourcingWithoutInvoicePercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { outsourcingWithoutInvoicePercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="0"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                        <div className="mt-2 text-xs text-slate-600">
                                                            è¨ˆç®—é¡: {formatCurrency(selectedCompany.revenue * (selectedCompany.outsourcingWithoutInvoicePercent / 100))}å††
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰ */}
                                            <div className="bg-green-50 p-4 rounded-lg">
                                                <h4 className="font-semibold text-slate-700 mb-3">ãã®ä»–è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚ã‚Šï¼‰</h4>
                                                {/* å…¥åŠ›æ–¹å¼é¸æŠ */}
                                                <div className="flex gap-2 mb-3">
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { expenseWithInvoiceInputMode: 'manual' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.expenseWithInvoiceInputMode === 'manual'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-green-400'
                                                        }`}
                                                    >
                                                        æ‰‹å…¥åŠ›
                                                    </button>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { expenseWithInvoiceInputMode: 'percent' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.expenseWithInvoiceInputMode === 'percent'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-green-400'
                                                        }`}
                                                    >
                                                        ï¼…ã§å…¥åŠ›
                                                    </button>
                                                </div>

                                                {/* æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ */}
                                                {selectedCompany.expenseWithInvoiceInputMode === 'manual' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">è²©ç®¡è²»ï¼ˆç¨æŠœï¼‰</label>
                                                        <input
                                                            type="text"
                                                            value={formatInputValue(selectedCompany.expenseWithInvoice)}
                                                            onChange={(e) => updateCompany(selectedCompany.id, { expenseWithInvoice: parseNumber(e.target.value) })}
                                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                )}

                                                {/* ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ */}
                                                {selectedCompany.expenseWithInvoiceInputMode === 'percent' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">è²©ç®¡è²»ç‡ï¼ˆå£²ä¸Šã«å¯¾ã™ã‚‹ï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.expenseWithInvoicePercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { expenseWithInvoicePercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="20"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                        <div className="mt-2 text-xs text-slate-600">
                                                            è¨ˆç®—é¡: {formatCurrency(selectedCompany.revenue * (selectedCompany.expenseWithInvoicePercent / 100))}å††
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼‰ */}
                                            <div className="bg-orange-50 p-4 rounded-lg">
                                                <h4 className="font-semibold text-slate-700 mb-3">ãã®ä»–è²©ç®¡è²»ï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹ãªã—ï¼å…ç¨äº‹æ¥­è€…ç­‰ï¼‰</h4>
                                                <p className="text-xs text-orange-700 mb-2">â€»{year}å¹´{month}æœˆ: çµŒéæªç½®ã«ã‚ˆã‚Š{getTaxExemptDeductionRate(year, month) * 100}%æ§é™¤å¯èƒ½</p>
                                                {/* å…¥åŠ›æ–¹å¼é¸æŠ */}
                                                <div className="flex gap-2 mb-3">
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { expenseWithoutInvoiceInputMode: 'manual' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.expenseWithoutInvoiceInputMode === 'manual'
                                                                ? 'bg-orange-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-orange-400'
                                                        }`}
                                                    >
                                                        æ‰‹å…¥åŠ›
                                                    </button>
                                                    <button
                                                        onClick={() => updateCompany(selectedCompany.id, { expenseWithoutInvoiceInputMode: 'percent' })}
                                                        className={`flex-1 px-3 py-2 rounded-lg font-semibold text-sm transition-colors ${
                                                            selectedCompany.expenseWithoutInvoiceInputMode === 'percent'
                                                                ? 'bg-orange-600 text-white'
                                                                : 'bg-white text-slate-700 border-2 border-slate-300 hover:border-orange-400'
                                                        }`}
                                                    >
                                                        ï¼…ã§å…¥åŠ›
                                                    </button>
                                                </div>

                                                {/* æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ */}
                                                {selectedCompany.expenseWithoutInvoiceInputMode === 'manual' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">è²©ç®¡è²»ï¼ˆç¨æŠœï¼‰</label>
                                                        <input
                                                            type="text"
                                                            value={formatInputValue(selectedCompany.expenseWithoutInvoice)}
                                                            onChange={(e) => updateCompany(selectedCompany.id, { expenseWithoutInvoice: parseNumber(e.target.value) })}
                                                            className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right"
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                )}

                                                {/* ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ */}
                                                {selectedCompany.expenseWithoutInvoiceInputMode === 'percent' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">è²©ç®¡è²»ç‡ï¼ˆå£²ä¸Šã«å¯¾ã™ã‚‹ï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.expenseWithoutInvoicePercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { expenseWithoutInvoicePercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="5"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                        <div className="mt-2 text-xs text-slate-600">
                                                            è¨ˆç®—é¡: {formatCurrency(selectedCompany.revenue * (selectedCompany.expenseWithoutInvoicePercent / 100))}å††
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* ç¤¾ä¿ä¼šç¤¾è² æ‹… */}
                                        <div className="bg-amber-50 p-4 rounded-lg">
                                            <label className="flex items-center justify-between mb-3">
                                                <span className="text-slate-700 font-semibold">ç¤¾ä¿ä¼šç¤¾è² æ‹…ã‚’äººä»¶è²»ã«å«ã‚ã‚‹</span>
                                                <button
                                                    onClick={() => updateCompany(selectedCompany.id, { includeSocialInsurance: !selectedCompany.includeSocialInsurance })}
                                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                                                        selectedCompany.includeSocialInsurance ? 'bg-blue-600' : 'bg-slate-300'
                                                    }`}
                                                >
                                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                        selectedCompany.includeSocialInsurance ? 'translate-x-6' : 'translate-x-1'
                                                    }`} />
                                                </button>
                                            </label>

                                            {!selectedCompany.includeSocialInsurance && (
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">å½¹å“¡å ±é…¬ã®ç¤¾ä¿æ–™ç‡ï¼ˆï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.executiveSocialInsurancePercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { executiveSocialInsurancePercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="15"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">çµ¦ä¸ã®ç¤¾ä¿æ–™ç‡ï¼ˆï¼…ï¼‰</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                value={selectedCompany.salarySocialInsurancePercent || ''}
                                                                onChange={(e) => updateCompany(selectedCompany.id, { salarySocialInsurancePercent: Number(e.target.value) || 0 })}
                                                                className="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-right pr-10"
                                                                placeholder="15"
                                                                step="0.1"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">%</span>
                                                        </div>
                                                    </div>

                                                    <div className="bg-purple-100 p-3 rounded-lg">
                                                        <div className="text-sm font-semibold text-purple-800">ç¤¾ä¿åˆè¨ˆæ¦‚ç®—</div>
                                                        <div className="text-xl font-bold text-purple-900 mt-1">
                                                            {formatCurrency(
                                                                ((selectedCompany.executiveCompensationInputMode === 'percent' 
                                                                    ? selectedCompany.revenue * (selectedCompany.executiveCompensationPercent / 100) 
                                                                    : selectedCompany.executiveCompensation) * (selectedCompany.executiveSocialInsurancePercent / 100)) +
                                                                ((selectedCompany.salaryInputMode === 'percent' 
                                                                    ? selectedCompany.revenue * (selectedCompany.salaryPercent / 100) 
                                                                    : selectedCompany.salary) * (selectedCompany.salarySocialInsurancePercent / 100))
                                                            )}å††
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* å³ã‚«ãƒ©ãƒ ï¼šçµæœè¡¨ç¤º */}
                            <div className="lg:col-span-4">
                                <div className="space-y-6">
                                    {/* ã‚°ãƒ«ãƒ¼ãƒ—åˆç®—KPI */}
                                    {showGroupView && (
                                        <div className="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg shadow-xl p-6 text-white">
                                            <h2 className="text-2xl font-bold mb-4 flex items-center">
                                                <span className="mr-2">ğŸ“Š</span>
                                                ã‚°ãƒ«ãƒ¼ãƒ—åˆç®—
                                            </h2>
                                            <div className="space-y-3">
                                                <div className="bg-white/10 backdrop-blur rounded-lg p-3">
                                                    <div className="text-sm opacity-90 mb-1">ç¨è¾¼å£²ä¸Šï¼ˆå…¥é‡‘ï¼‰</div>
                                                    <div className="text-2xl font-bold text-blue-200">{formatCurrency(groupKPI.taxIncludedRevenue)}å††</div>
                                                </div>
                                                <div className="bg-white/10 backdrop-blur rounded-lg p-3">
                                                    <div className="text-sm opacity-90 mb-1">é ã‹ã‚Šæ¶ˆè²»ç¨</div>
                                                    <div className="text-xl font-bold text-yellow-200">{formatCurrency(groupKPI.receivedConsumptionTax)}å††</div>
                                                </div>
                                                <div className="bg-white/10 backdrop-blur rounded-lg p-3">
                                                    <div className="text-sm opacity-90 mb-1">å–¶æ¥­åˆ©ç›Šï¼ˆç¨æŠœï¼‰</div>
                                                    <div className={`text-3xl font-bold ${groupKPI.operatingProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                        {groupKPI.operatingProfit >= 0 ? '+' : ''}{formatCurrency(groupKPI.operatingProfit)}å††
                                                    </div>
                                                </div>
                                                <div className="bg-white/10 backdrop-blur rounded-lg p-3">
                                                    <div className="text-sm opacity-90 mb-1">æ¶ˆè²»ç¨ç´ä»˜é¡</div>
                                                    <div className="text-2xl font-bold">{formatCurrency(groupKPI.consumptionTax)}å††</div>
                                                </div>
                                                <div className="bg-white/10 backdrop-blur rounded-lg p-3">
                                                    <div className="text-sm opacity-90 mb-1">æ³•äººç¨ç­‰</div>
                                                    <div className="text-2xl font-bold">{formatCurrency(groupKPI.corporateTax)}å††</div>
                                                </div>
                                                <div className="bg-white/10 backdrop-blur rounded-lg p-3">
                                                    <div className="text-sm opacity-90 mb-1">ç¤¾ä¼šä¿é™ºæ–™åˆè¨ˆ</div>
                                                    <div className="text-2xl font-bold text-purple-200">{formatCurrency(groupKPI.totalSocialInsuranceCost)}å††</div>
                                                </div>
                                                <div className="bg-white/10 backdrop-blur rounded-lg p-3">
                                                    <div className="text-sm opacity-90 mb-1">ç¨å¼•å¾Œåˆ©ç›Šï¼ˆç¨æŠœï¼‰</div>
                                                    <div className={`text-2xl font-bold ${groupKPI.netProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                        {groupKPI.netProfit >= 0 ? '+' : ''}{formatCurrency(groupKPI.netProfit)}å††
                                                    </div>
                                                </div>
                                                {(() => {
                                                    const groupBeginningCash = companies.reduce((s, c) => s + (c.beginningCash || 0), 0);
                                                    const groupActualCash = groupKPI.actualCash + groupBeginningCash;
                                                    return (
                                                <div className="bg-white/20 backdrop-blur rounded-lg p-4 border-2 border-white/30">
                                                    <div className="text-base opacity-90 mb-1 font-bold">ğŸ’° å®Ÿè³ªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®‹é«˜</div>
                                                    <div className={`text-4xl font-bold ${groupActualCash >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                        {groupActualCash >= 0 ? '+' : ''}{formatCurrency(groupActualCash)}å††
                                                    </div>
                                                    <div className="text-xs opacity-75 mt-2">ç¨è¾¼å£²ä¸Šãƒ™ãƒ¼ã‚¹ï¼‹æœŸé¦–ç¾é‡‘</div>
                                                </div>
                                                    );
                                                })()}
                                            </div>

                                            {settings.showMonthlyCFSection !== false && (
                                                <div className="space-y-4 mt-4">
                                                    <MonthlyCFTable data={calculateGroupMonthlyCF(companies, year, settings)} year={year} isGroup />
                                                    <CashFlowChart data={calculateGroupMonthlyCF(companies, year, settings)} year={year} isGroup />
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* å€‹ç¤¾KPI */}
                                    <div className="bg-white rounded-lg shadow-lg p-6">
                                        <h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">
                                            {selectedCompany.name} ã®çµæœ
                                        </h2>
                                        <div className="space-y-3">
                                            {(() => {
                                                const kpi = calculateKPI(selectedCompany, year, month, settings);
                                                return (
                                                    <>
                                                        <div className="bg-blue-50 rounded-lg p-3 border-2 border-blue-200">
                                                            <div className="text-xs text-slate-600 mb-1">ç¨è¾¼å£²ä¸Šï¼ˆå…¥é‡‘ï¼‰</div>
                                                            <div className="text-xl font-bold text-blue-700">{formatCurrency(kpi.taxIncludedRevenue)}å††</div>
                                                        </div>
                                                        <div className="bg-yellow-50 rounded-lg p-3 border-2 border-yellow-200">
                                                            <div className="text-xs text-slate-600 mb-1">é ã‹ã‚Šæ¶ˆè²»ç¨</div>
                                                            <div className="text-lg font-bold text-yellow-700">{formatCurrency(kpi.receivedConsumptionTax)}å††</div>
                                                        </div>
                                                        <KPICard title="å–¶æ¥­åˆ©ç›Šï¼ˆç¨æŠœï¼‰" value={kpi.operatingProfit} />
                                                        <KPICard title="æ¶ˆè²»ç¨ç´ä»˜é¡" value={kpi.consumptionTax} />
                                                        <div className="bg-red-50 rounded-lg p-3 border-2 border-red-200">
                                                            <div className="text-xs text-slate-600 mb-1">æ³•äººç¨ç­‰åˆè¨ˆ</div>
                                                            <div className="text-lg font-bold text-red-700">{formatCurrency(kpi.corporateTax)}å††</div>
                                                            <div className="text-xs text-slate-500 mt-2 space-y-1">
                                                                <div>æ³•äººç¨: {formatCurrency(kpi.nationalCorporateTax)}å††</div>
                                                                <div>åœ°æ–¹æ³•äººç¨: {formatCurrency(kpi.localCorporateTax)}å††</div>
                                                                <div>æ³•äººäº‹æ¥­ç¨: {formatCurrency(kpi.businessTax)}å††</div>
                                                                <div>ç‰¹åˆ¥æ³•äººäº‹æ¥­ç¨: {formatCurrency(kpi.specialBusinessTax)}å††</div>
                                                                <div>æ³•äººä½æ°‘ç¨: {formatCurrency(kpi.residentTax)}å††</div>
                                                            </div>
                                                        </div>
                                                        <div className="bg-purple-50 rounded-lg p-3 border-2 border-purple-200">
                                                            <div className="text-xs text-slate-600 mb-1">ç¤¾ä¼šä¿é™ºæ–™åˆè¨ˆ</div>
                                                            <div className="text-lg font-bold text-purple-700">{formatCurrency(kpi.totalSocialInsuranceCost)}å††</div>
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                å½¹å“¡: {formatCurrency(kpi.executiveSocialInsuranceCost)}å†† / 
                                                                çµ¦ä¸: {formatCurrency(kpi.salarySocialInsuranceCost)}å††
                                                            </div>
                                                        </div>
                                                        <KPICard title="ç¨å¼•å¾Œåˆ©ç›Šï¼ˆç¨æŠœï¼‰" value={kpi.netProfit} />
                                                        <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 border-3 border-green-400 shadow-lg">
                                                            <div className="text-sm text-slate-700 font-bold mb-1">ğŸ’° å®Ÿè³ªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®‹é«˜</div>
                                                            <div className={`text-3xl font-bold ${kpi.actualCash >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                {kpi.actualCash >= 0 ? '+' : ''}{formatCurrency(kpi.actualCash)}å††
                                                            </div>
                                                            <div className="text-xs text-slate-500 mt-1">ç¨è¾¼å£²ä¸Šãƒ™ãƒ¼ã‚¹ã§è¨ˆç®—</div>
                                                        </div>

                                                        {settings.showIntermediateTaxSection !== false && (
                                                        <>
                                                        {/* ä¸­é–“æ¶ˆè²»ç¨ç”³å‘Šï¼ˆå‡ºåŠ›ï¼‰ */}
                                                        {(() => {
                                                            const interim = calculateInterimConsumptionTax(selectedCompany, year);
                                                            return (
                                                                <div className="bg-violet-50 rounded-lg p-4 border-2 border-violet-200">
                                                                    <h3 className="font-bold text-slate-800 mb-2">ä¸­é–“æ¶ˆè²»ç¨ç”³å‘Š</h3>
                                                                    <div className="space-y-2 text-sm">
                                                                        <div><strong>å¿…è¦æ€§:</strong> {interim.isRequired ? 'æœ‰' : 'ç„¡'}{interim.note && ` (${interim.note})`}</div>
                                                                        <div><strong>ç”³å‘Šãƒ»ç´ç¨å›æ•°:</strong> {interim.interimCount === 0 ? '0å›ï¼ˆä»»æ„ï¼‰' : `${interim.interimCount}å›/å¹´`}</div>
                                                                        {interim.periods.length > 0 && (
                                                                            <div className="mt-3 overflow-x-auto">
                                                                                <table className="w-full text-xs">
                                                                                    <thead><tr className="bg-violet-100"><th className="px-2 py-1 text-left">å›</th><th className="px-2 py-1 text-right">æ¶ˆè²»ç¨</th><th className="px-2 py-1 text-right">åœ°æ–¹æ¶ˆè²»ç¨</th><th className="px-2 py-1 text-right">åˆè¨ˆ</th><th className="px-2 py-1 text-left">ç´ä»˜æœŸé™</th></tr></thead>
                                                                                    <tbody>
                                                                                        {interim.periods.map(p => (
                                                                                            <tr key={p.periodNum} className="border-t border-violet-200">
                                                                                                <td className="px-2 py-1">{p.periodNum}</td>
                                                                                                <td className="px-2 py-1 text-right">{formatCurrency(p.consumptionTax)}å††</td>
                                                                                                <td className="px-2 py-1 text-right">{formatCurrency(p.localConsumptionTax)}å††</td>
                                                                                                <td className="px-2 py-1 text-right font-semibold">{formatCurrency(p.total)}å††</td>
                                                                                                <td className="px-2 py-1">{p.dueDate}</td>
                                                                                            </tr>
                                                                                        ))}
                                                                                    </tbody>
                                                                                </table>
                                                                            </div>
                                                                        )}
                                                                        <p className="text-xs text-slate-500 mt-2">â€»æå‡ºãªã—ï¼å‰å¹´å®Ÿç¸¾ã§ã®ç´ä»˜ç¾©å‹™ç™ºç”Ÿï¼ˆã¿ãªã—ç”³å‘Šï¼‰</p>
                                                                        <p className="text-xs text-slate-500">â€»ä»®æ±ºç®—ã§é‚„ä»˜ã¨ãªã‚‹å ´åˆã‚‚ä¸­é–“ç”³å‘Šã§ã¯0å††</p>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}

                                                        {/* æ³•äººç¨ä¸­é–“ç”³å‘Šï¼ˆå‡ºåŠ›ï¼‰ */}
                                                        {(() => {
                                                            const corp = calculateInterimCorporateTax(selectedCompany);
                                                            return (
                                                                <div className="bg-emerald-50 rounded-lg p-4 border-2 border-emerald-200">
                                                                    <h3 className="font-bold text-slate-800 mb-2">æ³•äººç¨ä¸­é–“ç”³å‘Š</h3>
                                                                    <div className="space-y-2 text-sm">
                                                                        <div><strong>ä¸­é–“ç”³å‘Šã®è¦å¦:</strong> {corp.isRequired ? 'å¿…è¦' : 'ä¸è¦ï¼ˆ10ä¸‡å††ä»¥ä¸‹ï¼‰'}</div>
                                                                        <div><strong>æ³•äººåŒºåˆ†:</strong> {corp.rateBasis}</div>
                                                                        <div className="mt-2 pt-2 border-t border-emerald-200">
                                                                            <div className="font-semibold text-emerald-800 mb-1">äºˆå®šç”³å‘Šæ–¹å¼ï¼ˆå‰å¹´å®Ÿç¸¾ï¼‰</div>
                                                                            <div className="text-xs space-y-1">
                                                                                <div>æ³•äººç¨: {formatCurrency(corp.scheduledNationalTax)}å††</div>
                                                                                <div>åœ°æ–¹æ³•äººç¨: {formatCurrency(corp.scheduledLocalTax)}å††</div>
                                                                                <div className="font-bold">ç´ç¨äºˆå®šé¡: {formatCurrency(corp.scheduledTotal)}å††</div>
                                                                            </div>
                                                                        </div>
                                                                        {corp.hasProvisionalInput && (
                                                                            <div className="mt-2 pt-2 border-t border-emerald-200">
                                                                                <div className="font-semibold text-emerald-800 mb-1">ä»®æ±ºç®—æ–¹å¼</div>
                                                                                <div className="text-xs space-y-1">
                                                                                    <div>æ³•äººç¨: {formatCurrency(corp.provisionalNationalTax)}å††</div>
                                                                                    <div>åœ°æ–¹æ³•äººç¨: {formatCurrency(corp.provisionalLocalTax)}å††</div>
                                                                                    <div className="font-bold">ç´ç¨äºˆå®šé¡: {formatCurrency(corp.provisionalTotal)}å††</div>
                                                                                    {corp.provisionalNote && <p className="text-slate-600 mt-1">{corp.provisionalNote}</p>}
                                                                                </div>
                                                                                <p className="text-xs text-slate-500 mt-2">â€»ä»®æ±ºç®—é¡ãŒäºˆå®šç”³å‘Šé¡ã‚’è¶…ãˆã‚‹å ´åˆã¯äºˆå®šç”³å‘ŠãŒæœ‰åˆ©ãªå ´åˆã‚ã‚Š</p>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}
                                                        </>
                                                        )}

                                                        {/* åŠ´åƒä¿é™ºå¹´åº¦æ›´æ–°ï¼ˆå‡ºåŠ›ï¼‰ */}
                                                        {(() => {
                                                            const labor = calculateLaborInsurance(selectedCompany, year);
                                                            return (
                                                                <div className="bg-sky-50 rounded-lg p-4 border-2 border-sky-200">
                                                                    <h3 className="font-bold text-slate-800 mb-2">åŠ´åƒä¿é™ºå¹´åº¦æ›´æ–°</h3>
                                                                    <div className="space-y-2 text-sm">
                                                                        <div><strong>äº‹æ¥­ã®ç¨®é¡:</strong> {labor.industryName}</div>
                                                                        <div className="mt-2 pt-2 border-t border-sky-200">
                                                                            <div className="font-semibold text-sky-800 mb-1">1. ä»Šå¹´åº¦æ¦‚ç®—ä¿é™ºæ–™</div>
                                                                            <div className="text-xs space-y-1">
                                                                                <div>äº‹æ¥­ä¸»è² æ‹…: {formatCurrency(labor.employerPortion)}å††</div>
                                                                                <div>åŠ´åƒè€…è² æ‹…: {formatCurrency(labor.workerPortion)}å††</div>
                                                                                <div className="font-bold">åˆè¨ˆ: {formatCurrency(labor.totalEstimated)}å††</div>
                                                                            </div>
                                                                        </div>
                                                                        <div className="pt-2 border-t border-sky-200">
                                                                            <div className="font-semibold text-sky-800 mb-1">2. å¹´åº¦æ›´æ–°ç´ä»˜é¡ï¼ˆç´ä»˜æœŸé™: {labor.dueDate}ï¼‰</div>
                                                                            <div className="font-bold text-lg">{formatCurrency(labor.annualUpdateTotal)}å††</div>
                                                                            {labor.prevSettlement !== 0 && (
                                                                                <p className="text-xs text-slate-600 mt-1">å†… å‰å¹´åº¦ç²¾ç®—: {formatCurrency(labor.prevSettlement)}å††</p>
                                                                            )}
                                                                        </div>
                                                                        {labor.canExtend && labor.installments.length > 0 && (
                                                                            <div className="pt-2 border-t border-sky-200">
                                                                                <div className="font-semibold text-sky-800 mb-1">3. å»¶ç´ï¼ˆ3å›åˆ†å‰²ï¼‰</div>
                                                                                <div className="text-xs space-y-1">
                                                                                    {labor.installments.map(p => (
                                                                                        <div key={p.period}>{p.period}æœŸ: {formatCurrency(p.amount)}å††ï¼ˆ{p.dueDate}ï¼‰</div>
                                                                                    ))}
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}

                                                        {settings.showMonthlyCFSection !== false && (
                                                        <div className="space-y-4 mt-4">
                                                            <MonthlyCFTable data={calculateMonthlyCashFlow(selectedCompany, year, settings)} year={year} />
                                                            <CashFlowChart data={calculateMonthlyCashFlow(selectedCompany, year, settings)} year={year} />
                                                        </div>
                                                        )}
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
                    <footer className="bg-slate-800 text-white text-center py-4 mt-8">
                        <p className="text-sm">Â© 2025 çµŒå–¶ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ« | æ¦‚ç®—è¨ˆç®—ç”¨ï¼ˆæ­£ç¢ºãªç¨å‹™è¨ˆç®—ã¯ç¨ç†å£«ã«ã”ç›¸è«‡ãã ã•ã„ï¼‰</p>
                    </footer>
                </div>
            );
        };

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>